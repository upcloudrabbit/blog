<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.19" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'dark';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><meta property="og:url" content="https://upcloudrabbit.github.io/blog/blog/article/i51fy95l/"><meta property="og:site_name" content="upcloudrabbit blog"><meta property="og:title" content="springboot 源码"><meta property="og:description" content="自动装配 SpringBoot 的自动装配主要通过注解@Import完成。该注解作用在自动配置类上，只有一个属性，可填写被@Configuration、@Component标注的类以及实现了org.springframework.context.annotation.ImportSelector、org.springframework.context...."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-12T14:00:06.000Z"><meta property="article:tag" content="java"><meta property="article:tag" content="springboot"><meta property="article:modified_time" content="2025-02-12T14:00:06.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"springboot 源码","image":[""],"dateModified":"2025-02-12T14:00:06.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>springboot 源码 | upcloudrabbit blog</title><meta name="description" content="自动装配 SpringBoot 的自动装配主要通过注解@Import完成。该注解作用在自动配置类上，只有一个属性，可填写被@Configuration、@Component标注的类以及实现了org.springframework.context.annotation.ImportSelector、org.springframework.context...."><link rel="preload" href="/blog/assets/style-BEcvEdyM.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BEcvEdyM.css"><link rel="modulepreload" href="/blog/assets/app-CJfFg5nr.js"><link rel="modulepreload" href="/blog/assets/index.html-DZm2FJoA.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-68cd6b44><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d5a8d0bc></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-d5a8d0bc> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-68cd6b44 data-v-d34f28d6><div class="vp-navbar" vp-navbar data-v-d34f28d6 data-v-70d97d16><div class="wrapper" data-v-70d97d16><div class="container" data-v-70d97d16><div class="title" data-v-70d97d16><div class="vp-navbar-title" data-v-70d97d16 data-v-2c8d4622><a class="vp-link no-icon link title" href="/blog/" data-v-2c8d4622 data-v-442a52aa><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" src="/blog/EditBlog.png" alt data-v-7fbfbc9b><!--]--><!--[--><img class="vp-image light logo" src="/blog/EditBlog.png" alt data-v-7fbfbc9b><!--]--><!--]--><!--]--><span data-v-2c8d4622>upcloudrabbit blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-70d97d16><div class="content-body" data-v-70d97d16><!--[--><!--]--><div class="vp-navbar-search search" data-v-70d97d16><div class="search-wrapper" data-v-97535d1e><!----><div id="local-search" data-v-97535d1e><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-97535d1e><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-70d97d16 data-v-d43c1732><span id="main-nav-aria-label" class="visually-hidden" data-v-d43c1732>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/categories/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>分类</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>归档</span><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-70d97d16 data-v-a295abf6><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-a295abf6 data-v-596c25a9 data-v-d84fedac><span class="check" data-v-d84fedac><span class="icon" data-v-d84fedac><!--[--><span class="vpi-sun sun" data-v-596c25a9></span><span class="vpi-moon moon" data-v-596c25a9></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-70d97d16 data-v-ad52545c data-v-40bac536><!--[--><a class="vp-social-link no-icon" href="https://github.com/upcloudrabbit" aria-label="github" target="_blank" rel="noopener" data-v-40bac536 data-v-67b21932><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-70d97d16 data-v-652282fd data-v-feafea4e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-feafea4e><span class="vpi-more-horizontal icon" data-v-feafea4e></span></button><div class="menu" data-v-feafea4e><div class="vp-menu" data-v-feafea4e data-v-709dc2b1><!----><!--[--><!--[--><!----><div class="group" data-v-652282fd><div class="item appearance" data-v-652282fd><p class="label" data-v-652282fd>外观</p><div class="appearance-action" data-v-652282fd><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-652282fd data-v-596c25a9 data-v-d84fedac><span class="check" data-v-d84fedac><span class="icon" data-v-d84fedac><!--[--><span class="vpi-sun sun" data-v-596c25a9></span><span class="vpi-moon moon" data-v-596c25a9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-652282fd><div class="item social-links" data-v-652282fd><div class="vp-social-links social-links-list" data-v-652282fd data-v-40bac536><!--[--><a class="vp-social-link no-icon" href="https://github.com/upcloudrabbit" aria-label="github" target="_blank" rel="noopener" data-v-40bac536 data-v-67b21932><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-70d97d16 data-v-2b50024d><span class="container" data-v-2b50024d><span class="top" data-v-2b50024d></span><span class="middle" data-v-2b50024d></span><span class="bottom" data-v-2b50024d></span></span></button></div></div></div></div><div class="divider" data-v-70d97d16><div class="divider-line" data-v-70d97d16></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-68cd6b44 data-v-1dc3518c><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-1dc3518c><span class="vpi-align-left menu-icon" data-v-1dc3518c></span><span class="menu-text" data-v-1dc3518c>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-1dc3518c data-v-423a73ec><button data-v-423a73ec>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-68cd6b44 data-v-eb709286><div class="vp-doc-container is-blog" data-v-eb709286 data-v-e0bef33b><!--[--><!--]--><div class="container" data-v-e0bef33b><!----><div class="content" data-v-e0bef33b><div class="content-container" data-v-e0bef33b><!--[--><!--]--><main class="main" data-v-e0bef33b><nav class="vp-breadcrumb" data-v-e0bef33b data-v-1ae4ad7a><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-1ae4ad7a><!--[--><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-1ae4ad7a></span><meta property="name" content="首页" data-v-1ae4ad7a><meta property="position" content="1" data-v-1ae4ad7a></li><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=93f725" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->java<!--]--><!----></a><span class="vpi-chevron-right" data-v-1ae4ad7a></span><meta property="name" content="java" data-v-1ae4ad7a><meta property="position" content="2" data-v-1ae4ad7a></li><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb current" href="/blog/article/i51fy95l/" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->springboot 源码<!--]--><!----></a><!----><meta property="name" content="springboot 源码" data-v-1ae4ad7a><meta property="position" content="3" data-v-1ae4ad7a></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-581be9b0>springboot 源码 <!----></h1><div class="vp-doc-meta" data-v-581be9b0><p class="reading-time" data-v-581be9b0><span class="vpi-books icon" data-v-581be9b0></span><span data-v-581be9b0>约 10350 字</span><span data-v-581be9b0>大约 35 分钟</span></p><p data-v-581be9b0><span class="vpi-tag icon" data-v-581be9b0></span><!--[--><a class="vp-link no-icon link tag vp-tag-5rx4" href="/blog/tags/?tag=java" data-v-581be9b0 data-v-442a52aa><!--[-->java<!--]--><!----></a><a class="vp-link no-icon link tag vp-tag-t6m3" href="/blog/tags/?tag=springboot" data-v-581be9b0 data-v-442a52aa><!--[-->springboot<!--]--><!----></a><!--]--></p><p class="create-time" data-v-581be9b0><span class="vpi-clock icon" data-v-581be9b0></span><span data-v-581be9b0>2025-02-12</span></p></div><!--]--><div class="_article_i51fy95l_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-e0bef33b><div data-v-e0bef33b><h2 id="自动装配" tabindex="-1"><a class="header-anchor" href="#自动装配"><span>自动装配</span></a></h2><p>SpringBoot 的自动装配主要通过注解<code>@Import</code>完成。该注解作用在自动配置类上，只有一个属性，可填写被<code>@Configuration、@Component</code>标注的类以及实现了<code>org.springframework.context.annotation.ImportSelector、org.springframework.context.annotation.ImportBeanDefinitionRegistrar</code>接口的子类。</p><ul><li>实现 ImportSelector 接口时需要实现<code>selectImports</code>方法，该方法用于向容器中注入一个组件或者配置。以下为示例：</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> BarImportSelector</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ImportSelector</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> String</span><span style="color:#61AFEF;">[] selectImports</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;font-style:italic;"> annotationMetadata</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">[] {</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">BarConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">()};</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> BarConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> Bar</span><span style="color:#61AFEF;"> bbbar</span><span style="color:#ABB2BF;">()</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Bar</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ImportBeanDefinitionRegistrar 用于向 spring 容器中注入新的组件（该组件可以是临时自行定义的）。这个新的组件指的是<code>BeanDefinition</code>也就是 bean 的元数据，以下为示例：</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> WaiterRegister</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ImportBeanDefinitionRegistrar</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerBeanDefinitions</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;font-style:italic;"> importingClassMetadata</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;font-style:italic;"> registry</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        registry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerBeanDefinition</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;waiter&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> RootBeanDefinition</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Waiter</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>DeferredImportSelector</code>主要用于实现条件装配，实现该接口的类加载时机位于 ImportSelector 之后 ImportBeanDefinitionRegistrar 之前。示例如下：</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> WaiterDeferredImportSelector</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> DeferredImportSelector</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> String</span><span style="color:#61AFEF;">[] selectImports</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;font-style:italic;"> annotationMetadata</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">[] {</span><span style="color:#E5C07B;">Waiter</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">()};</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="条件装配" tabindex="-1"><a class="header-anchor" href="#条件装配"><span>条件装配</span></a></h2><p>Spring Boot 的条件装配主要依赖<code>@Profile</code>和<code>@Condition</code>两大注解。</p><ul><li><code>@Profile</code>注解用于标注在<code>@Component</code>类上，其属性填写需要生效的环境名称（可填写多个），缺点是过于宽泛</li><li><code>@Conditional</code>提供了更为精细的控制。它与实现了<code>org.springframework.context.annotation.Condition</code>接口的类进行关联，在实现类中可手写是否需要生效逻辑。基于此注解，Spring Boot 扩展实现了 ConditionalOnxxx 等注解用于判断组件是否需要自动引入</li></ul><h2 id="spi" tabindex="-1"><a class="header-anchor" href="#spi"><span>SPI</span></a></h2><p>SPI（Service Provider Interface）即通过接口定义来加载具体的实现类，由于 JDK 自身的 SPI 定义过于简陋，因此大部分的三方框架都有自定义的 SPI，Spring 也是</p><ul><li>JDK SPI：JDK 的 SPI 实现需要先定义接口（抽象类也行）以及实现类，然后在 META-INF/services 目录下新建文件名同接口（抽象类）的全限定名，文件内写实现类的全限定名，如有多个按行展开即可。最后通过指定的方法进行加载</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#E5C07B;"> java.util.ServiceLoader</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#E5C07B;"> java.util.stream.Stream</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#E5C07B;">    ServiceLoader</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> load </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ServiceLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">load</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    load</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forEach</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">out</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">println);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Spring SPI：Spring 的 SPI 则是通过在 META-INF 目录下新建 spring.factories 文件，其书写规则为：类/接口/注解的全限定名 为 key，实现类为 value 的全限定名，多个实现类以<code>,</code>进行分隔。参考 spring-boot-autoconfiguration</li></ul><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">org.springframework.context.ApplicationContextInitializer</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">\</span></span>
<span class="line"><span style="color:#98C379;">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span></span>
<span class="line"><span style="color:#98C379;">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">org.springframework.context.ApplicationListener</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">\</span></span>
<span class="line"><span style="color:#98C379;">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加载时通过 Spring 提供的方法进行加载</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">import</span><span style="color:#E5C07B;"> org.springframework.core.io.support.SpringFactoriesLoader</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 加载 bean</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> beans </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> SpringFactoriesLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadFactories</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getContextClassLoader</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 加载 bean 名称</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> beanNames </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> SpringFactoriesLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadFactoryNames</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Bar</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Thread</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentThread</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getContextClassLoader</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring SPI 在加载配置类时底层缓存了所有加载过的类，因此重复调用也不存在性能问题，具体实现如下：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E5C07B;"> List</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> loadFactories</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> factoryType</span><span style="color:#ABB2BF;">,</span><span style="color:#ABB2BF;"> @</span><span style="color:#E5C07B;">Nullable</span><span style="color:#E5C07B;"> ClassLoader</span><span style="color:#E06C75;"> classLoader) {</span></span>
<span class="line"><span style="color:#E5C07B;">    ClassLoader</span><span style="color:#E06C75;"> classLoaderToUse </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> classLoader</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (classLoaderToUse </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">        classLoaderToUse </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> SpringFactoriesLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClassLoader</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取加载指定 bean 类型的全限定名</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> factoryImplementationNames </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> loadFactoryNames</span><span style="color:#E06C75;">(factoryType</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> classLoaderToUse)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTraceEnabled</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trace</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Loaded [&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> factoryType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;] names: &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> factoryImplementationNames);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> result </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">factoryImplementationNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 前面以及得到了类的全限定名，这里直接通过反射加载生成实例</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> factoryImplementationName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> factoryImplementationNames) {</span></span>
<span class="line"><span style="color:#E5C07B;">        result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">instantiateFactory</span><span style="color:#ABB2BF;">(factoryImplementationName, factoryType, classLoaderToUse));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 排序后进行返回</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationAwareOrderComparator</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sort</span><span style="color:#ABB2BF;">(result);</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> List</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">String</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> loadFactoryNames</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> factoryType</span><span style="color:#ABB2BF;">,</span><span style="color:#ABB2BF;"> @</span><span style="color:#E5C07B;">Nullable</span><span style="color:#E5C07B;"> ClassLoader</span><span style="color:#E06C75;"> classLoader) {</span></span>
<span class="line"><span style="color:#E5C07B;">    String</span><span style="color:#E06C75;"> factoryTypeName </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> factoryType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> loadSpringFactories</span><span style="color:#E06C75;">(classLoader)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getOrDefault</span><span style="color:#ABB2BF;">(factoryTypeName, </span><span style="color:#E5C07B;">Collections</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">emptyList</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> Map</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">String</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> List</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">String</span><span style="color:#56B6C2;">&gt;&gt;</span><span style="color:#61AFEF;"> loadSpringFactories</span><span style="color:#E06C75;">(</span><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Nullable</span><span style="color:#E5C07B;"> ClassLoader</span><span style="color:#E06C75;"> classLoader) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 缓存中有则直接返回</span></span>
<span class="line"><span style="color:#E5C07B;">    MultiValueMap</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> result </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> cache</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(classLoader);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (result </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E06C75;"> result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过类加载器加载所有 jar 下的 META-INF/spring.factories 文件 </span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        Enumeration</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">URL</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> urls </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (classLoader </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#C678DD;"> ?</span></span>
<span class="line"><span style="color:#E5C07B;">                                 classLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getResources</span><span style="color:#ABB2BF;">(FACTORIES_RESOURCE_LOCATION)</span><span style="color:#C678DD;"> :</span></span>
<span class="line"><span style="color:#E5C07B;">                                 ClassLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getSystemResources</span><span style="color:#ABB2BF;">(FACTORIES_RESOURCE_LOCATION)</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        result </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedMultiValueMap</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 循环遍历并解析成 properties，这里使用的是 MultiValueMap，对应一个 key 有多个 value</span></span>
<span class="line"><span style="color:#C678DD;">        while</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">urls</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hasMoreElements</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            URL</span><span style="color:#E06C75;"> url </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> urls</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nextElement</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">            UrlResource</span><span style="color:#E06C75;"> resource </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> UrlResource</span><span style="color:#E06C75;">(url)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            Properties</span><span style="color:#E06C75;"> properties </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> PropertiesLoaderUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadProperties</span><span style="color:#ABB2BF;">(resource);</span></span>
<span class="line"><span style="color:#C678DD;">            for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Entry</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> ?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> entry </span><span style="color:#C678DD;">:</span><span style="color:#E5C07B;"> properties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">entrySet</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                String</span><span style="color:#E06C75;"> factoryTypeName </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((String) </span><span style="color:#E5C07B;">entry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getKey</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trim</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">                for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> factoryImplementationName </span><span style="color:#C678DD;">:</span><span style="color:#E5C07B;"> StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">commaDelimitedListToStringArray</span><span style="color:#ABB2BF;">((String) </span><span style="color:#E5C07B;">entry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getValue</span><span style="color:#ABB2BF;">())</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                    result</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(factoryTypeName, </span><span style="color:#E5C07B;">factoryImplementationName</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trim</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 放入缓存中</span></span>
<span class="line"><span style="color:#E5C07B;">        cache</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(classLoader, result);</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E06C75;"> result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">IOException</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">(</span><span style="color:#98C379;">&quot;Unable to load factories from location [&quot;</span><span style="color:#56B6C2;"> +</span></span>
<span class="line"><span style="color:#E06C75;">                                           FACTORIES_RESOURCE_LOCATION </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;]&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E5C07B;"> T</span><span style="color:#61AFEF;"> instantiateFactory</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> factoryImplementationName</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> factoryType</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ClassLoader</span><span style="color:#E06C75;"> classLoader) {</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 通过反射加载类（这里底层用的还是 Class.forName，Spring 这里多了缓存和数组类生成机制）</span></span>
<span class="line"><span style="color:#E5C07B;">        Class</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> factoryImplementationClass </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forName</span><span style="color:#ABB2BF;">(factoryImplementationName, classLoader);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">factoryType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isAssignableFrom</span><span style="color:#ABB2BF;">(factoryImplementationClass)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#98C379;">                &quot;Class [&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> factoryImplementationName </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;] is not assignable to factory type [&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> factoryType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &quot;]&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 反射生成新的实例（本质用的还是 java 的反射实现，Spring 这里多了对构造方法的访问权限判断）</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E06C75;"> (T) </span><span style="color:#E5C07B;">ReflectionUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">accessibleConstructor</span><span style="color:#ABB2BF;">(factoryImplementationClass).</span><span style="color:#61AFEF;">newInstance</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalArgumentException</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#98C379;">            &quot;Unable to instantiate factory class [&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E06C75;"> factoryImplementationName </span><span style="color:#56B6C2;">+</span><span style="color:#98C379;"> &quot;] for factory type [&quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> factoryType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> +</span><span style="color:#98C379;"> &quot;]&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">            ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="springbootapplication-注解分析" tabindex="-1"><a class="header-anchor" href="#springbootapplication-注解分析"><span>@SpringBootApplication 注解分析</span></a></h2><p><code>@SpringBootApplication</code>是一个复合注解，它是由<code>@SpringBootConfiguration、@EnableAutoConfiguration、@ComponentScan</code>组合而成。在 1.2.0 版本之前需要用户主动在 Spring Boot 的主启动类上声明这三个注解。以下为这三个注解作用详解</p><ul><li>@ComponentScan 用于扫描主启动类以及其下子包中的所有组件。Spring Boot 的主启动类默认在所有类包的最外层（只有这样才能扫描到所有的组件，当然也可通过注解属性对扫描包进行自定义）它默认使用了两个过滤器 <ol><li>TypeExcludeFilter：通过类型判断排除需要加载的组件</li><li>AutoConfigurationExcludeFilter 用于排除在 spring.factories 中定义的需要自动装配的配置类</li></ol></li><li>@SpringBootConfiguration 乍一看只是 @Configuration 注解的别名，实际用于 Spring Boot Test 运行时寻找配置类的入口（被 @SpringBootConfiguration、@SpringBootApplication 标注的类）</li><li>@EnableAutoConfiguration 是 Spring Boot 实现自动装配的核心，该注解用于启用 Spring Boot 的自动装配，根据导入的依赖和配置合理的加载所需内容。该注解同样是一个复合注解，由<code>@AutoConfigurationPackage、@Import(AutoConfigurationImportSelector.class)</code>组合而来 <ol><li>@AutoConfigurationPackage 相当于 @Import(AutoConfigurationPackages.Registrar.class) 注解的别名（该注解在 2.3.0 之前不可指定包路径和类路径），AutoConfigurationPackages.Registrar.class 类用于将主启动类子路径注册到容器中。该路径主要由两个用途：提供给 Spring Boot 自身使用以及提供给三方的 starters 使用，以下为注册实现：</li></ol></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> Registrar</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> ImportBeanDefinitionRegistrar</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> DeterminableImports</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerBeanDefinitions</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;font-style:italic;"> metadata</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;font-style:italic;"> registry</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 直接向容器中注册 bean，通过注解的 AnnotationMetadata 可获取到标注类的包名</span></span>
<span class="line"><span style="color:#61AFEF;">        register</span><span style="color:#ABB2BF;">(registry, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> PackageImports</span><span style="color:#ABB2BF;">(metadata).</span><span style="color:#61AFEF;">getPackageNames</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">toArray</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]));</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Object</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#61AFEF;"> determineImports</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;font-style:italic;"> metadata</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> Collections</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">singleton</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> PackageImports</span><span style="color:#ABB2BF;">(metadata));</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">PackageImports</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;"> metadata) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取被 AutoConfigurationPackage 注解标注的类</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationAttributes</span><span style="color:#E06C75;"> attributes </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> AnnotationAttributes</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">fromMap</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">metadata</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getAnnotationAttributes</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AutoConfigurationPackage</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> packageNames </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 提取 basePackages 属性的值（多个）</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> basePackage </span><span style="color:#C678DD;">:</span><span style="color:#E5C07B;"> attributes</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStringArray</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;basePackages&quot;</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        packageNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(basePackage);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 提取 basePackageClasses 属性的值（多个）</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Class</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> basePackageClass </span><span style="color:#C678DD;">:</span><span style="color:#E5C07B;"> attributes</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClassArray</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;basePackageClasses&quot;</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        packageNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">basePackageClass</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPackage</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果未手动指定基础包名或者类则使用被 @SpringBootApplication 标注的主启动类子包</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">packageNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        packageNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPackageName</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">metadata</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClassName</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">packageNames</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Collections</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unmodifiableList</span><span style="color:#ABB2BF;">(packageNames);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> register</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> packageNames</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果容器中已经有了 AutoConfigurationPackages.class（BEAN 就是）那就修改该 bean</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 的构造方法，传入子包路径</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">registry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsBeanDefinition</span><span style="color:#ABB2BF;">(BEAN)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        BeanDefinition</span><span style="color:#E06C75;"> beanDefinition </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> registry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanDefinition</span><span style="color:#ABB2BF;">(BEAN);</span></span>
<span class="line"><span style="color:#E5C07B;">        ConstructorArgumentValues</span><span style="color:#E06C75;"> constructorArguments </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanDefinition</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConstructorArgumentValues</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        constructorArguments</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addIndexedArgumentValue</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">addBasePackages</span><span style="color:#ABB2BF;">(constructorArguments, packageNames));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果没有包含则创建一个新的 beanDefinition，构造方法同样传入子包路径</span></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        GenericBeanDefinition</span><span style="color:#E06C75;"> beanDefinition </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> GenericBeanDefinition</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">        beanDefinition</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setBeanClass</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BasePackages</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        beanDefinition</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConstructorArgumentValues</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">addIndexedArgumentValue</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, packageNames);</span></span>
<span class="line"><span style="color:#E5C07B;">        beanDefinition</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setRole</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanDefinition</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ROLE_INFRASTRUCTURE</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        registry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerBeanDefinition</span><span style="color:#ABB2BF;">(BEAN, beanDefinition);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>2. @Import(AutoConfigurationImportSelector.class) 用于加载自动配置类，AutoConfigurationImportSelector 重写了 DeferredImportSelector 接口的 getImportGroup 方法，其核心实现都在`org.springframework.boot.autoconfigure.AutoConfigurationImportSelector.AutoConfigurationGroup#process`中
</code></pre><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> process</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;"> annotationMetadata</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> DeferredImportSelector</span><span style="color:#E06C75;"> deferredImportSelector) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">state</span><span style="color:#ABB2BF;">(deferredImportSelector </span><span style="color:#C678DD;">instanceof</span><span style="color:#ABB2BF;"> AutoConfigurationImportSelector,</span></span>
<span class="line"><span style="color:#ABB2BF;">                 () </span><span style="color:#C678DD;">-&gt;</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">format</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Only %s implementations are supported, got %s&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                     AutoConfigurationImportSelector</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getSimpleName</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#E5C07B;">                                     deferredImportSelector</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClass</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取需要加载的配置类</span></span>
<span class="line"><span style="color:#E5C07B;">    AutoConfigurationEntry</span><span style="color:#E06C75;"> autoConfigurationEntry </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> ((AutoConfigurationImportSelector) deferredImportSelector)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">getAutoConfigurationEntry</span><span style="color:#ABB2BF;">(annotationMetadata);</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">autoConfigurationEntries</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(autoConfigurationEntry);</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> importClassName </span><span style="color:#C678DD;">:</span><span style="color:#E5C07B;"> autoConfigurationEntry</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConfigurations</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">entries</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">putIfAbsent</span><span style="color:#ABB2BF;">(importClassName, annotationMetadata);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#E5C07B;"> AutoConfigurationEntry</span><span style="color:#61AFEF;"> getAutoConfigurationEntry</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;"> annotationMetadata) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">isEnabled</span><span style="color:#E06C75;">(annotationMetadata)) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E06C75;"> EMPTY_ENTRY</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationAttributes</span><span style="color:#E06C75;"> attributes </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getAttributes</span><span style="color:#E06C75;">(annotationMetadata)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过 SPI 加载自动配置类 </span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> configurations </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getCandidateConfigurations</span><span style="color:#E06C75;">(annotationMetadata</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> attributes)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 去除重复的配置类 </span></span>
<span class="line"><span style="color:#E06C75;">    configurations </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> removeDuplicates</span><span style="color:#E06C75;">(configurations)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取要显示移除的配置类</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> exclusions </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getExclusions</span><span style="color:#E06C75;">(annotationMetadata</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> attributes)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 校验这些类是存在的</span></span>
<span class="line"><span style="color:#61AFEF;">    checkExcludedClasses</span><span style="color:#E06C75;">(configurations</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> exclusions)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 去除无需引入的配置类</span></span>
<span class="line"><span style="color:#E5C07B;">    configurations</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">removeAll</span><span style="color:#ABB2BF;">(exclusions);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里是配置需要过滤的配置类</span></span>
<span class="line"><span style="color:#E06C75;">    configurations </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getConfigurationClassFilter</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">filter</span><span style="color:#ABB2BF;">(configurations);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 广播 AutoConfigurationImportEvent 事件</span></span>
<span class="line"><span style="color:#61AFEF;">    fireAutoConfigurationImportEvents</span><span style="color:#E06C75;">(configurations</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> exclusions)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> AutoConfigurationEntry</span><span style="color:#E06C75;">(configurations</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> exclusions)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="webmvc-场景下自动装配" tabindex="-1"><a class="header-anchor" href="#webmvc-场景下自动装配"><span>WebMVC 场景下自动装配</span></a></h2><h3 id="servlet-装配" tabindex="-1"><a class="header-anchor" href="#servlet-装配"><span>Servlet 装配</span></a></h3><p>在引入 spring-boot-starter-web 组件后，Spring Boot 将自动启用 WebMvc 环境的自动装配，该组件的核心配置类为<code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code>要使该配置类生效需满足以下几个条件：</p><ul><li>当前环境必须是 WebMvc（Servlet 环境）导入 WebMvc 依赖后自动生效（若同时导入 WebFlux 则 WebMvc 生效）</li><li>当前类的路径下必须有<code>Servlet、DispatcherServlet、WebMvcConfigurer</code></li><li>项目中未自定义注册 WebMvcConfigurationSupport 的类或者子类</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">proxyBeanMethods</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnWebApplication</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">type</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Type</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SERVLET</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">({ </span><span style="color:#E5C07B;">Servlet</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> DispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> WebMvcConfigurer</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;"> })</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnMissingBean</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WebMvcConfigurationSupport</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AutoConfigureOrder</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">HIGHEST_PRECEDENCE</span><span style="color:#56B6C2;"> +</span><span style="color:#D19A66;"> 10</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AutoConfigureAfter</span><span style="color:#E06C75;">({ </span><span style="color:#E5C07B;">DispatcherServletAutoConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> TaskExecutionAutoConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">		ValidationAutoConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;"> })</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> WebMvcAutoConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">                     </span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AutoConfigureOrder</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">HIGHEST_PRECEDENCE</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">proxyBeanMethods</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnWebApplication</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">type</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Type</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SERVLET</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">DispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AutoConfigureAfter</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ServletWebServerFactoryAutoConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> DispatcherServletAutoConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;"> </span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">proxyBeanMethods</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">AutoConfigureOrder</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">HIGHEST_PRECEDENCE</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ServletRequest</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnWebApplication</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">type</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Type</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SERVLET</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">EnableConfigurationProperties</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ServerProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Import</span><span style="color:#E06C75;">({ </span><span style="color:#E5C07B;">ServletWebServerFactoryAutoConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">BeanPostProcessorsRegistrar</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">ServletWebServerFactoryConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">EmbeddedTomcat</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">ServletWebServerFactoryConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">EmbeddedJetty</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">ServletWebServerFactoryConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">EmbeddedUndertow</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;"> })</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> ServletWebServerFactoryAutoConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 用于传入默认的配置</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#C678DD;">	public</span><span style="color:#E5C07B;"> ServletWebServerFactoryCustomizer</span><span style="color:#61AFEF;"> servletWebServerFactoryCustomizer</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ServerProperties</span><span style="color:#E06C75;font-style:italic;"> serverProperties</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ServletWebServerFactoryCustomizer</span><span style="color:#ABB2BF;">(serverProperties);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 用于传入默认的配置</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;org.apache.catalina.startup.Tomcat&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">	public</span><span style="color:#E5C07B;"> TomcatServletWebServerFactoryCustomizer</span><span style="color:#61AFEF;"> tomcatServletWebServerFactoryCustomizer</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#E5C07B;">			ServerProperties</span><span style="color:#E06C75;font-style:italic;"> serverProperties</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> TomcatServletWebServerFactoryCustomizer</span><span style="color:#ABB2BF;">(serverProperties);</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 添加转发头过滤器</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">ConditionalOnMissingFilterBean</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ForwardedHeaderFilter</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">ConditionalOnProperty</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;server.forward-headers-strategy&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> havingValue</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;framework&quot;</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">	public</span><span style="color:#E5C07B;"> FilterRegistrationBean</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">ForwardedHeaderFilter</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#61AFEF;"> forwardedHeaderFilter</span><span style="color:#ABB2BF;">()</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">		ForwardedHeaderFilter</span><span style="color:#E06C75;"> filter</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ForwardedHeaderFilter</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">		FilterRegistrationBean</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">ForwardedHeaderFilter</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">registration</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> FilterRegistrationBean</span><span style="color:#ABB2BF;">&lt;&gt;(filter);</span></span>
<span class="line"><span style="color:#E5C07B;">		registration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setDispatcherTypes</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">DispatcherType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">REQUEST</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">DispatcherType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ASYNC</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">DispatcherType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ERROR</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">		registration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setOrder</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">HIGHEST_PRECEDENCE</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#ABB2BF;"> registration;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据注解中体现的先后顺序可知，WebMvc 自动装配环节为：Servlet 装配 -&gt; DispatcherServlet 装配 -&gt; WebMvc 装配。EmbeddedTomcat、EmbeddedJetty、EmbeddedUndertow 这三个类用于判断该实例化哪个容器（默认是 tomcat）BeanPostProcessorsRegistrar 用于向容器中注册两个后置处理器（主要用于定制化容器内容），源码如下：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerBeanDefinitions</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">AnnotationMetadata</span><span style="color:#E06C75;"> importingClassMetadata</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                    BeanDefinitionRegistry</span><span style="color:#E06C75;"> registry) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 用于定制化 WebServer 配置，例如自定义一些额外的路由</span></span>
<span class="line"><span style="color:#61AFEF;">    registerSyntheticBeanIfMissing</span><span style="color:#E06C75;">(registry</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;webServerFactoryCustomizerBeanPostProcessor&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                   WebServerFactoryCustomizerBeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 用于自定义错误页面</span></span>
<span class="line"><span style="color:#61AFEF;">    registerSyntheticBeanIfMissing</span><span style="color:#E06C75;">(registry</span><span style="color:#ABB2BF;">,</span><span style="color:#98C379;"> &quot;errorPageRegistrarBeanPostProcessor&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                   ErrorPageRegistrarBeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>tomcat 的配置的默认值可以在 spring-boot-autoconfigure 包下的 META-INF/spring-configuration-metadata.json 中找到</p><h3 id="dispatcherservlet-装配" tabindex="-1"><a class="header-anchor" href="#dispatcherservlet-装配"><span>DispatcherServlet 装配</span></a></h3><p>Spring Boot 项目默认使用 Servlet 3.0 以上的规范，即不再使用 web.xml 进行配置转而引入<code>@WebServlet、@WebFilter、@WebListener</code>注解进行配置。Spring Boot 本身并不支持扫描 Servlet 三大组件（Servlet、Filter、Listener）它提供了另外的两种注册方式：</p><ol><li>在主启动类上添加 @ServletComponentScan，该注解用于扫项目中的自定义 Servlet 原生组件</li><li>借助辅助注册器 RegistrationsBean，该方式一般用于引入三方 jar 包中存在的 Servlet 原生组件。本质是通过实现 ServletContextInitializer 接口注册 bean 的方式使得，Servlet 上下文初始化后调用钩子方法完成注册。</li></ol><p>DispatchServlet 注册流程为：首先通过 DispatcherServletConfiguration 注册 DispatcherServlet 自己（本质就是 HttpServlet）-&gt; 通过 DispatcherServletRegistrationConfiguration （上面的第二种方法）注册到 Spring Boot 中</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> DEFAULT_DISPATCHER_SERVLET_BEAN_NAME </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;dispatcherServlet&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	 * The bean name for a ServletRegistrationBean for the DispatcherServlet &quot;/&quot;.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;dispatcherServletRegistration&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">proxyBeanMethods</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Conditional</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">DefaultDispatcherServletCondition</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ServletRegistration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">EnableConfigurationProperties</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WebMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> DispatcherServletConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Bean</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> DispatcherServlet</span><span style="color:#61AFEF;"> dispatcherServlet</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">WebMvcProperties</span><span style="color:#E06C75;font-style:italic;"> webMvcProperties</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 注册自己</span></span>
<span class="line"><span style="color:#E5C07B;">        DispatcherServlet</span><span style="color:#E06C75;"> dispatcherServlet</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> DispatcherServlet</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        dispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setDispatchOptionsRequest</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isDispatchOptionsRequest</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        dispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setDispatchTraceRequest</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isDispatchTraceRequest</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        dispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setThrowExceptionIfNoHandlerFound</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isThrowExceptionIfNoHandlerFound</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        dispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setPublishEvents</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isPublishRequestHandledEvents</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        dispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEnableLoggingRequestDetails</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isLogRequestDetails</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#ABB2BF;"> dispatcherServlet;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">ConditionalOnBean</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">MultipartResolver</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">ConditionalOnMissingBean</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> DispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">MULTIPART_RESOLVER_BEAN_NAME</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> MultipartResolver</span><span style="color:#61AFEF;"> multipartResolver</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MultipartResolver</span><span style="color:#E06C75;font-style:italic;"> resolver</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // Detect if the user has created a MultipartResolver but named it incorrectly</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#ABB2BF;"> resolver;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Configuration</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">proxyBeanMethods</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> false</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Conditional</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">DispatcherServletRegistrationCondition</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">ConditionalOnClass</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ServletRegistration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">EnableConfigurationProperties</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">WebMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Import</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">DispatcherServletConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> DispatcherServletRegistrationConfiguration</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">Bean</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)</span></span>
<span class="line"><span style="color:#ABB2BF;">    @</span><span style="color:#E5C07B;">ConditionalOnBean</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> DispatcherServlet</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> name</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#E5C07B;"> DispatcherServletRegistrationBean</span><span style="color:#61AFEF;"> dispatcherServletRegistration</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">DispatcherServlet</span><span style="color:#E06C75;font-style:italic;"> dispatcherServlet</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                                                           WebMvcProperties</span><span style="color:#E06C75;font-style:italic;"> webMvcProperties</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">ObjectProvider</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">MultipartConfigElement</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;font-style:italic;">multipartConfig</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 注册到 spring boot 中</span></span>
<span class="line"><span style="color:#E5C07B;">        DispatcherServletRegistrationBean</span><span style="color:#E06C75;"> registration</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> DispatcherServletRegistrationBean</span><span style="color:#ABB2BF;">(dispatcherServlet,</span></span>
<span class="line"><span style="color:#E5C07B;">                                                                                               webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getServlet</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getPath</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        registration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setName</span><span style="color:#ABB2BF;">(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span></span>
<span class="line"><span style="color:#E5C07B;">        registration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setLoadOnStartup</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">webMvcProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getServlet</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getLoadOnStartup</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">        multipartConfig</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ifAvailable</span><span style="color:#ABB2BF;">(registration</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">setMultipartConfig);</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#ABB2BF;"> registration;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="springmvc-装配" tabindex="-1"><a class="header-anchor" href="#springmvc-装配"><span>SpringMvc 装配</span></a></h3><p>当 Serverlet 和 DispatcherServlet 都装配完成后，就是 SpringMvc 的装配了。SpringMvc 的装配主要依赖其下的两个子类<code>WebMvcAutoConfigurationAdapter、EnableWebMvcConfiguration</code></p><ul><li>WebMvcAutoConfigurationAdapter 用于配置消息转换器、异步支持、 url 匹配、视图解析、国际化支持等</li><li>EnableWebMvcConfiguration 用于注册 HandleMapping（url 映射）、HandleAdapter（url 对应的处理逻辑）、全局异常处理、静态资源解析、欢迎页面、index 页面等</li></ul><p>具体定义可查看<code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code></p><h1 id="ioc-容器" tabindex="-1"><a class="header-anchor" href="#ioc-容器"><span>IOC 容器</span></a></h1><h2 id="spring-ioc-容器" tabindex="-1"><a class="header-anchor" href="#spring-ioc-容器"><span>Spring IOC 容器</span></a></h2><ul><li>BeanFactory 作为 IOC 容器的顶层抽象，它定义了最基础的 bean 对象管理，主要有以下几方面的特性： <ul><li>基础的容器</li><li>定义了作用域的概念</li><li>集成环境配置</li><li>支持多种类型的配置源</li><li>层次性设计</li><li>完整的生命周期控制机制</li></ul></li><li>HierarchicalBeanFactory 作为 BeanFactory 的直接子类仅仅多了父子结构。对于父子结构就是对多个 Spring 上下文的关系描述</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationConfigApplicationContext</span><span style="color:#E06C75;"> ctx1 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> AnnotationConfigApplicationContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BeanDefinitionConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationConfigApplicationContext</span><span style="color:#E06C75;"> ctx2 </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> AnnotationConfigApplicationContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BeanDefinitionConfiguration</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里 ctx2 就是 ctx1 的父容器</span></span>
<span class="line"><span style="color:#E5C07B;">    ctx1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setParent</span><span style="color:#ABB2BF;">(ctx2);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ListableBeanFactory 同样作为 BeanFactory 的直接子类实现了容器中 bean 的可选择性列举。可选择性列举表示为两点： <ol><li>不会列举父容器中的 bean</li><li>不会列举通过<code>beanFactory.registerSingleton()</code>注册的 bean（主要用于向外部隐藏 Spring 的内部组件）</li></ol></li><li>AutowireCapableBeanFactory 用于提供给那些没有被 Spring Framework 管理的 bean 自动注入支持，通常用于与第三方框架进行集成（通过该接口注入 bean 时 Spring 将无法控制 bean 的生命周期，这里很好理解毕竟是三方的 bean 无法预知）</li><li>ConfigurableBeanFactory 接口提供了对容器中 bean 的写入操作（Spring 的类起名都非常规范，一般带有 Configurable 表示这个类提供 set 方法可以进行修改，反之则只读）但是获取 ConfigurableBeanFactory 已经是在 Spring 上下文初始化完成了，文档也强烈不推荐使用该接口提供的方法对容器中的 bean 进行修改</li><li>DefaultListableBeanFactory 是目前底层唯一在使用 BeanFactory 落地实现，它完成了注册 bean 定义信息的动作，由此可见完整的 BeanFactory 对 bean 管理应该是：先注册 bean 的定义信息再完成 bean 的创建和初始化动作</li><li>ApplicationContext 是基于 BeanFactory 的拓展接口，它提供了更为强大功能具体体现在：更多访问 bean 的方法、加载文件资源、事件发布、国际化支持、层级关系支持（这里的层级关系指的是动态增强、资源记载、事件监听机制等多方面扩展功能）这些拓展主要是通过继承对应的接口实现的</li><li>ConfigurableApplicationContext 继承 ApplicationContext 接口提供了修改能力，它会被绝大多数的 ApplicationContext 最终实现类实现。该类提供了对 Spring 上下文进行刷新的 refresh 方法，主要流程为：注册新的 bean -&gt; 调用 refresh 方法 -&gt; 销毁上下文方法</li><li>AbstractApplicationContext 中对 refresh 流程进行了定义（<!---->）同时也会将自己作为一个 bean 注册到容器中以支持不同类型组件注入</li><li>GenericApplicationContext 用于实现注解驱动 IOC 容器，作为通用的 ApplicationContext 实现，它只被允许刷新一次上下文，xml 配置文件之类的实现可实现重复刷新。除此之外它还聚合了 DefaultListableBeanFactory 用于自定义 bean 之类的操作</li></ul><p>实际项目开发时应该选择 ApplicationContext，而不是 BeanFactory。前者提供了 bean 的生命周期管理、bean 后置处理器、 beanFactory 后置处理器、国际化以及事件发布机制</p><h2 id="spring-boot-ioc-容器" tabindex="-1"><a class="header-anchor" href="#spring-boot-ioc-容器"><span>Spring Boot IOC 容器</span></a></h2><p>Spring Boot 本身没有直接使用 Spring 现有的 IOC 容器，而是针对嵌入式 Web 容器这块拓展出更为强大的 IOC 容器，在 Spring Boot2.x 版本中额外添加了 WebFlux 与 WebMvc 平级提供了响应式的 Web 编程实现</p><ul><li>WebServerApplicationContext 直接对 ApplicationContext 进行拓展，添加了<code>getWebServer</code>之一重要方法</li><li>AnnotationConfigServletWebServerApplicationContext 用于整合 WebMvc 的最终落地实现</li><li>ReactiveWebServerApplicationContext 和 AnnotationConfigReactiveWebServerApplicationContext 则主要针对 WebFlux 进行拓展和最终落地实现</li></ul><h2 id="beandefinition" tabindex="-1"><a class="header-anchor" href="#beandefinition"><span>BeanDefinition</span></a></h2><p>该接口用于定义描述 bean 的元信息，其中主要包含以下几个部分（<code>org.springframework.beans.factory.config.BeanDefinition</code>）：</p><ul><li>Bean 的类信息：全限定名（beanClassName）</li><li>Bean 的属性：作用域（scope）、是否默认 Bean（primary）、描述信息（description）等</li><li>Bean 的行为特性：是否延迟加载（lazy）、是否自动注入（autoWireCandidate）、初始化/销毁方法（initMethod/destroyMethod）等</li><li>Bean 与其它 Bean 的关系：父 Bean 名称（parentName）、依赖的 Bean（dependOn）等</li><li>Bean 的配置属性：构造方法参数（constructorArgumentValues）、属性变量值（PropertyValues）等</li></ul><p>BeanDefinition 并非顶级接口，其上下均有父接口和实现。以下列举一些比较重要的类：</p><ul><li>AttributeAccessor 用于提供对 Bean 属性进行增、删、改、查的方法</li><li>BeanMetadataElement 用于获取容器中 Bean 的加载来源，大多数情况是从 URL 中进行加载</li><li>AbstractBeanDefinition 用于提取具体实现类的公共实现（实现模板方法）其实已经实现了绝大多数的方法</li><li>GenericBeanDefinition 具有层次性，其作为默认的 BeanDefinition，支持在后置处理器中动态的变更父 BeanDefinition</li><li>ChildBeanDefinition 则必须指定父 BeanDefinition</li><li>RootBeanDefinition 只能单独作为 BeanDefinition 或者父 BeanDefinition 出现，绝大多是情况下不允许变更父 BeanDefinition</li></ul><p>BeanDefinitionRegistry 用于管理所有的 BeanDefinition，具体实现为<code>org.springframework.beans.factory.support.DefaultListableBeanFactory</code></p><h2 id="后置处理器" tabindex="-1"><a class="header-anchor" href="#后置处理器"><span>后置处理器</span></a></h2><p>Spring 中的后置处理器主要分为两种类型：</p><ol><li>BeanPostProcessor 用于对 Bean 对象进行后置处理，其切入时机是在 Bean 对象初始化阶段前后。一般用于在 Bean 对象初始化阶段前后添加自定义逻辑</li><li>BeanFactoryPostProcessor 用于对 BeanDefinition 进行后置处理，切入时机是在所有 BeanDefinition 都注册到 BeanDefinitionRegistry 后。一般用于修改已经存在的 BeanDefinition</li></ol><p>上述两种类型只是主要接口，除此之外还有一些拓展子接口，其切入时机分布在 IOC 容器生命周期的各个阶段，如下图所示：</p><p><img src="/blog/assets/1-Cx2rtj_i.jpeg" alt="" width="995" height="1144"></p><p>以下是一些重要的后置处理器方法调用时机说明：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> BeanPostProcessor</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 属性赋值&amp;依赖注入之后初始化逻辑回调之前（也就是 @PostContruct 之前）</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Nullable</span></span>
<span class="line"><span style="color:#C678DD;">	default</span><span style="color:#E5C07B;"> Object</span><span style="color:#61AFEF;"> postProcessBeforeInitialization</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;font-style:italic;"> bean</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;font-style:italic;"> beanName</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#ABB2BF;"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 初始化逻辑之后，也就是 init-method 之后</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Nullable</span></span>
<span class="line"><span style="color:#C678DD;">	default</span><span style="color:#E5C07B;"> Object</span><span style="color:#61AFEF;"> postProcessAfterInitialization</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;font-style:italic;"> bean</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;font-style:italic;"> beanName</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#ABB2BF;"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> InstantiationAwareBeanPostProcessor</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> BeanPostProcessor</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实例化 Bean 对象之前</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Nullable</span></span>
<span class="line"><span style="color:#C678DD;">	default</span><span style="color:#E5C07B;"> Object</span><span style="color:#61AFEF;"> postProcessBeforeInstantiation</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;font-style:italic;">beanClass</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;font-style:italic;"> beanName</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实例化对象之后</span></span>
<span class="line"><span style="color:#C678DD;">	default</span><span style="color:#C678DD;"> boolean</span><span style="color:#61AFEF;"> postProcessAfterInstantiation</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;font-style:italic;"> bean</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;font-style:italic;"> beanName</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实例化对象之后</span></span>
<span class="line"><span style="color:#ABB2BF;">	@</span><span style="color:#E5C07B;">Nullable</span></span>
<span class="line"><span style="color:#C678DD;">	default</span><span style="color:#E5C07B;"> PropertyValues</span><span style="color:#61AFEF;"> postProcessProperties</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">PropertyValues</span><span style="color:#E06C75;font-style:italic;"> pvs</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;font-style:italic;"> bean</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;font-style:italic;"> beanName</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">			throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">		return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">FunctionalInterface</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 初始化 Bean 对象之前</span></span>
<span class="line"><span style="color:#C678DD;">	void</span><span style="color:#61AFEF;"> postProcessBeanFactory</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic;"> beanFactory</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> interface</span><span style="color:#E5C07B;"> BeanDefinitionRegistryPostProcessor</span><span style="color:#C678DD;"> extends</span><span style="color:#E5C07B;"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 初始化 Bean 对象之前（位于 BeanFactoryPostProcessor 之前）</span></span>
<span class="line"><span style="color:#C678DD;">	void</span><span style="color:#61AFEF;"> postProcessBeanDefinitionRegistry</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;font-style:italic;"> registry</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;"> throws</span><span style="color:#E5C07B;"> BeansException</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="springapplicationrunlistener" tabindex="-1"><a class="header-anchor" href="#springapplicationrunlistener"><span>SpringApplicationRunListener</span></a></h1><p>在对 Spring Boot 做一些系统级别的事件监听时，通常不能使用<code>@Component</code>注解等常规的 Bean 注册方法实现。原因很简单：Spring 在广播事件时通过注解实现的这些监听器还未注册，解决方法有两种：</p><ol><li>通过实现<code>org.springframework.boot.SpringApplicationRunListener</code>接口对应的方法，然后配置到 spring.factories 中通过 SPI 机制自动加载</li><li>实现<code>org.springframework.boot.SpringApplicationRunListener</code>接口对应的方法，然后通过手动编程对监听器进行注册</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> Demo03Application</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">[] </span><span style="color:#E06C75;font-style:italic;">args</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 1. 直接创建 SpringApplication</span></span>
<span class="line"><span style="color:#E5C07B;">        SpringApplication</span><span style="color:#E06C75;"> springApplication</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SpringApplication</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Demo03Application</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        springApplication</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addListeners</span><span style="color:#ABB2BF;">(event </span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">        });</span></span>
<span class="line"><span style="color:#E5C07B;">        springApplication</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">run</span><span style="color:#ABB2BF;">(args);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 2. 链式调用，本质和 1 一样</span></span>
<span class="line"><span style="color:#E5C07B;">        SpringApplicationBuilder</span><span style="color:#E06C75;"> springApplicationBuilder</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SpringApplicationBuilder</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        springApplicationBuilder</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">main</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Demo03Application</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">listeners</span><span style="color:#ABB2BF;">(event </span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;"> {}).</span><span style="color:#61AFEF;">run</span><span style="color:#ABB2BF;">(args);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码是通过 lambda 直接实现的 ApplicationListener 接口，如果是实现 SpringApplicationRunListener 接口则必须在实现类中定义一个两个参数的构造方法，如下所示：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> class</span><span style="color:#E5C07B;"> Demo03Application</span><span style="color:#C678DD;"> implements</span><span style="color:#E5C07B;"> SpringApplicationRunListener</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    public</span><span style="color:#61AFEF;"> Demo03Application</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">SpringApplication</span><span style="color:#E06C75;font-style:italic;"> application</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">[] </span><span style="color:#E06C75;font-style:italic;">args</span><span style="color:#ABB2BF;">)</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下表为 SpringApplicationRunListener 接口可监听事件说明：</p><table><thead><tr><th>接口方法</th><th>事件类型</th><th>可获得的组件</th><th>回调时机</th></tr></thead><tbody><tr><td>starting</td><td>ApplicationStartingEvent</td><td>无</td><td>调用 SpringApplication 的 run 方法时立刻调用</td></tr><tr><td>environmentPrepared</td><td>ApplicationEnvironmentPreparedEvent</td><td>ConfigurableEnvironment</td><td>Environment 构建完成，但在创建 ApplicationContext 之前</td></tr><tr><td>contextPrepared</td><td>ConfigurableApplicationContext</td><td>ApplicationContextInitializedEvent</td><td>创建和准备 ApplicationContext 之后，但在加载之前</td></tr><tr><td>contextLoaded</td><td>ConfigurableApplicationContext</td><td>ApplicationPreparedEvent</td><td>ApplicationContext 已加载，但尚未刷新容器时</td></tr><tr><td>started</td><td>ConfigurableApplicationContext</td><td>ApplicationStartedEvent</td><td>IOC 容器已刷新。但未调用 CommandLineRunners 和 ApplicationRunners 时</td></tr><tr><td>running</td><td>ConfigurableApplicationContext</td><td>ApplicationReadyEvent</td><td>在 run 方法彻底完成之前</td></tr><tr><td>failed</td><td>ConfigurableApplicationContext，Throwable</td><td>ApplicationFailedEvent</td><td>run 方法执行过程中抛出异常时</td></tr></tbody></table><h1 id="spring-boot-启动流程" tabindex="-1"><a class="header-anchor" href="#spring-boot-启动流程"><span>Spring Boot 启动流程</span></a></h1><p>Spring Boot 启动流程如下：</p><h2 id="创建-application" tabindex="-1"><a class="header-anchor" href="#创建-application"><span>创建 Application</span></a></h2><p>大多数情况下 Spring Boot 应用启动类都是上面标注<code>@SpringBootApplication</code>然后在 main 方法中直接调用<code>SpringApplication.run</code>运行，在 run 之前首先要创建 SpringApplication，源码如下：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 将主启动类包装成数组</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> ConfigurableApplicationContext</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> primarySource</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> args</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">(</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Class</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] { primarySource }</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> args)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 创建 SpringApplication 然后调用 run 方法，这里先只看 SpringApplication 创建</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#E5C07B;"> ConfigurableApplicationContext</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] primarySources</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SpringApplication</span><span style="color:#E06C75;">(primarySources)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">run</span><span style="color:#ABB2BF;">(args);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 重载调用</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> SpringApplication</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> primarySources</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> primarySources)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// SpringApplication 构造方法</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> SpringApplication</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ResourceLoader</span><span style="color:#E06C75;"> resourceLoader</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> primarySources</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> resourceLoader</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">notNull</span><span style="color:#ABB2BF;">(primarySources, </span><span style="color:#98C379;">&quot;PrimarySources must not be null&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 记录主启动类</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">primarySources</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Arrays</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">asList</span><span style="color:#ABB2BF;">(primarySources)</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 判断应用环境</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">webApplicationType</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> WebApplicationType</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">deduceFromClasspath</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置重对象预初始化器，该初始化器从 2.4.0 版本开始引入，目的是通过 BootstrapRegistryInitializer</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 提前注册一些创建耗时的重对象，这些注册的对象会在 ApplicationContext 初始化之前进行预创建</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">bootstrapRegistryInitializers</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#61AFEF;">        getSpringFactoriesInstances</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BootstrapRegistryInitializer</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置应用初始化器</span></span>
<span class="line"><span style="color:#61AFEF;">    setInitializers</span><span style="color:#E06C75;">((Collection) </span><span style="color:#61AFEF;">getSpringFactoriesInstances</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ApplicationContextInitializer</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置监听器（原理同上）</span></span>
<span class="line"><span style="color:#61AFEF;">    setListeners</span><span style="color:#E06C75;">((Collection) </span><span style="color:#61AFEF;">getSpringFactoriesInstances</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ApplicationListener</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">))</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 确认主启动类</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mainApplicationClass</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> deduceMainApplicationClass</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!----><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;">[] SERVLET_INDICATOR_CLASSES </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> { </span><span style="color:#98C379;">&quot;javax.servlet.Servlet&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;">                                                           &quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span><span style="color:#E06C75;"> }</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> WEBMVC_INDICATOR_CLASS </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;org.springframework.web.servlet.DispatcherServlet&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> WEBFLUX_INDICATOR_CLASS </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;org.springframework.web.reactive.DispatcherHandler&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> JERSEY_INDICATOR_CLASS </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> SERVLET_APPLICATION_CONTEXT_CLASS </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;org.springframework.web.context.WebApplicationContext&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> REACTIVE_APPLICATION_CONTEXT_CLASS </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#E5C07B;"> WebApplicationType</span><span style="color:#61AFEF;"> deduceFromClasspath</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 首先判断 REACTIVE 环境</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 判断逻辑为必须包含 WEBFLUX 核心文件且同时不含 WEBMVC 和JERSEY</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isPresent</span><span style="color:#ABB2BF;">(WEBFLUX_INDICATOR_CLASS, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isPresent</span><span style="color:#ABB2BF;">(WEBMVC_INDICATOR_CLASS, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#56B6C2;">        &amp;&amp;</span><span style="color:#56B6C2;"> !</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isPresent</span><span style="color:#ABB2BF;">(JERSEY_INDICATOR_CLASS, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> WebApplicationType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">REACTIVE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 判断既不是 REACTIVE 也不是 SERVLET</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 判断逻辑为，均不包含 SERVLET 核心包</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> className </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> SERVLET_INDICATOR_CLASSES) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isPresent</span><span style="color:#ABB2BF;">(className, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            return</span><span style="color:#E5C07B;"> WebApplicationType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">NONE</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 最后只能是 SERVLET</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> WebApplicationType</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SERVLET</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 方法包装</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E5C07B;"> Collection</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> getSpringFactoriesInstances</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> type) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> getSpringFactoriesInstances</span><span style="color:#E06C75;">(type</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> Class</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;">[] {})</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#56B6C2;"> &lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E5C07B;"> Collection</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> getSpringFactoriesInstances</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">T</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> type</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;">[] parameterTypes</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Object</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> args</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取类加载器，这里获取到的是线程上下文类加载器</span></span>
<span class="line"><span style="color:#E5C07B;">    ClassLoader</span><span style="color:#E06C75;"> classLoader </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getClassLoader</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过 SPI 加载 ApplicationContextInitializer 类型的配置类</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ApplicationContextInitializer 用于在刷新容器之前初始化 ConfigurableApplicationContext</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 一般用于根据上下文环境激活配置文件</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> names </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">SpringFactoriesLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">loadFactoryNames</span><span style="color:#ABB2BF;">(type, classLoader)</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过反射创建实例</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> instances </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createSpringFactoriesInstances</span><span style="color:#E06C75;">(type</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> parameterTypes</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> classLoader</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> args</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> names)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 按照 Order 进行排序</span></span>
<span class="line"><span style="color:#E5C07B;">    AnnotationAwareOrderComparator</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sort</span><span style="color:#ABB2BF;">(instances);</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> instances</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#61AFEF;"> deduceMainApplicationClass</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 通过创建异常获取当前调用堆栈</span></span>
<span class="line"><span style="color:#E5C07B;">        StackTraceElement</span><span style="color:#E06C75;">[] stackTrace </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> RuntimeException</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getStackTrace</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 遍历堆栈返回 main 方法所在的主类</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">StackTraceElement</span><span style="color:#E06C75;"> stackTraceElement </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> stackTrace) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#98C379;">&quot;main&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">equals</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">stackTraceElement</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getMethodName</span><span style="color:#ABB2BF;">())</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">                return</span><span style="color:#E5C07B;"> Class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forName</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">stackTraceElement</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClassName</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">ClassNotFoundException</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // Swallow and continue</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="启动-springapplication" tabindex="-1"><a class="header-anchor" href="#启动-springapplication"><span>启动 SpringApplication</span></a></h2><p>启动就是 run 方法的执行，源码如下：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> ConfigurableApplicationContext</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> args</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 记录启动时间</span></span>
<span class="line"><span style="color:#C678DD;">    long</span><span style="color:#E06C75;"> startTime </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 重对象初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里的创建其实就是在调用在创建 SpringApplication 是注册的 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // bootstrapRegistryInitializers</span></span>
<span class="line"><span style="color:#E5C07B;">    DefaultBootstrapContext</span><span style="color:#E06C75;"> bootstrapContext </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createBootstrapContext</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableApplicationContext</span><span style="color:#E06C75;"> context </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置 Spring Boot 启动无需依赖显示器</span></span>
<span class="line"><span style="color:#61AFEF;">    configureHeadlessProperty</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取 SpringApplicationRunListeners 实现 SpringApplication 启动阶段的事件发布、监听</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里由于之前已经在 SpringApplication 构造方法中获取了 SpringApplicationListeners</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 因此这里是从缓存中获取的</span></span>
<span class="line"><span style="color:#E5C07B;">    SpringApplicationRunListeners</span><span style="color:#E06C75;"> listeners </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getRunListeners</span><span style="color:#E06C75;">(args)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 发布 ApplicationStartingEvent 事件（第一个事件）</span></span>
<span class="line"><span style="color:#E5C07B;">    listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">starting</span><span style="color:#ABB2BF;">(bootstrapContext, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mainApplicationClass</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 封装并解析命令行传入的参数 args 并将其注册到容器中</span></span>
<span class="line"><span style="color:#E5C07B;">        ApplicationArguments</span><span style="color:#E06C75;"> applicationArguments </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> DefaultApplicationArguments</span><span style="color:#E06C75;">(args)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 创建并将环境参数绑定到容器的 Bean 中（这里的环境会根据之前 SpringApplication 构造</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 方法中判定的环境动态创建）同时发布 ApplicationEnvironmentPreparedEvent 事件</span></span>
<span class="line"><span style="color:#E5C07B;">        ConfigurableEnvironment</span><span style="color:#E06C75;"> environment </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> prepareEnvironment</span><span style="color:#E06C75;">(listeners</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> bootstrapContext</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> applicationArguments)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里只是判断并设置是否需要忽略指定的 Bean</span></span>
<span class="line"><span style="color:#61AFEF;">        configureIgnoreBeanInfo</span><span style="color:#E06C75;">(environment)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 根据 environment 输出 Banner</span></span>
<span class="line"><span style="color:#E5C07B;">        Banner</span><span style="color:#E06C75;"> printedBanner </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> printBanner</span><span style="color:#E06C75;">(environment)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里会根据之前判断的环境创建相应的 IOC 容器（注意这里只是创建，并未初始化）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // servlet -&gt; AnnotationConfigServletWebServerApplicationContext</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // reactive -&gt; AnnotationConfigReactiveWebServerApplicationContext</span></span>
<span class="line"><span style="color:#E06C75;">        context </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createApplicationContext</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 用作 spring boot 启动性能分析，提供给 metrics 使用需要配合 actator starter 使用。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 同时也支持提供 JFR 事件</span></span>
<span class="line"><span style="color:#E5C07B;">        context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setApplicationStartup</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationStartup</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 上下文环境准备，主要内容如下：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 1. 为 context 设置 environment</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 2. IOC 容器后置处理，主要是设置 资源和类加载器</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 3. 调用之前注册的 ApplicationContextInitializer 中的 initialize 方法</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 4. 发布 ApplicationContextInitializedEvent 事件</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 5. 发布 BootstrapContextClosedEvent 事件</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 6. 将 Banner 和 参数 封装成 Bean 注册到容器中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 7. 加载配置源（这里就是按照扫描主类和其子包下的组件，获取其元数据 BeanDefinition）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 8. 发布 ApplicationPreparedEvent 事件</span></span>
<span class="line"><span style="color:#61AFEF;">        prepareContext</span><span style="color:#E06C75;">(bootstrapContext</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> context</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> listeners</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> applicationArguments</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> printedBanner)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 刷新上下文，这里是 Spring 的核心方法</span></span>
<span class="line"><span style="color:#61AFEF;">        refreshContext</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 空方法，留给以后的子类拓展使用</span></span>
<span class="line"><span style="color:#61AFEF;">        afterRefresh</span><span style="color:#E06C75;">(context</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> applicationArguments)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 记录启动过程耗费时间</span></span>
<span class="line"><span style="color:#E5C07B;">        Duration</span><span style="color:#E06C75;"> timeTakenToStartup </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Duration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ofNanos</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> startTime);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">logStartupInfo</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            new</span><span style="color:#61AFEF;"> StartupInfoLogger</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mainApplicationClass</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">logStarted</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getApplicationLog</span><span style="color:#ABB2BF;">(), timeTakenToStartup);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 发布 ApplicationStartedEvent 事件</span></span>
<span class="line"><span style="color:#E5C07B;">        listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">started</span><span style="color:#ABB2BF;">(context, timeTakenToStartup);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 调用注册的 ApplicationRunner 和 CommandLineRunner（这两个接口用于在 1.x 版本给</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 开发者提供 Spring Boot 启动后的回调，但是现在不再使用。以后的版本都通过事件监听实现</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ApplicationStartedEvent）</span></span>
<span class="line"><span style="color:#61AFEF;">        callRunners</span><span style="color:#E06C75;">(context</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> applicationArguments)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 所有的异常都会发布 ApplicationFailedEvent 事件</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">        handleRunFailure</span><span style="color:#E06C75;">(context</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ex</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> listeners)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalStateException</span><span style="color:#E06C75;">(ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        Duration</span><span style="color:#E06C75;"> timeTakenToReady </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Duration</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ofNanos</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">nanoTime</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> startTime);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 发布 ApplicationReadyEvent 事件</span></span>
<span class="line"><span style="color:#E5C07B;">        listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ready</span><span style="color:#ABB2BF;">(context, timeTakenToReady);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">Throwable</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">        handleRunFailure</span><span style="color:#E06C75;">(context</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> ex</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalStateException</span><span style="color:#E06C75;">(ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> context</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是流程逐步拆解（<!---->）</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> ConfigurableEnvironment</span><span style="color:#61AFEF;"> prepareEnvironment</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">SpringApplicationRunListeners</span><span style="color:#E06C75;"> listeners</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                                                   DefaultBootstrapContext</span><span style="color:#E06C75;"> bootstrapContext</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ApplicationArguments</span><span style="color:#E06C75;"> applicationArguments) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Create and configure the environment</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取或者创建 ConfigurableEnvironment</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableEnvironment</span><span style="color:#E06C75;"> environment </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getOrCreateEnvironment</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 组合环境配置</span></span>
<span class="line"><span style="color:#61AFEF;">    configureEnvironment</span><span style="color:#E06C75;">(environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> applicationArguments</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getSourceArgs</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 将 PropertySource 调整为 ConfigurationPropertySource，使其可用 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // PropertySourcesPropertyResolver 进行解析</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurationPropertySources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">attach</span><span style="color:#ABB2BF;">(environment);</span></span>
<span class="line"><span style="color:#E5C07B;">    listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">environmentPrepared</span><span style="color:#ABB2BF;">(bootstrapContext, environment);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 将默认配置移到最后</span></span>
<span class="line"><span style="color:#E5C07B;">    DefaultPropertiesPropertySource</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">moveToEnd</span><span style="color:#ABB2BF;">(environment);</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">state</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">environment</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsProperty</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;spring.main.environment-prefix&quot;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#98C379;">                 &quot;Environment prefix cannot be set via properties.&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里是将配置文件中的 spring.main 开头的属性绑定到 SpringApplication 中</span></span>
<span class="line"><span style="color:#61AFEF;">    bindToSpringApplication</span><span style="color:#E06C75;">(environment)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果没有自定义占位符解析器就使用默认解析器解析</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">isCustomEnvironment</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        EnvironmentConverter</span><span style="color:#E06C75;"> environmentConverter </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> EnvironmentConverter</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">getClassLoader</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        environment </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> environmentConverter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">convertEnvironmentIfNecessary</span><span style="color:#ABB2BF;">(environment, </span><span style="color:#61AFEF;">deduceEnvironmentClass</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 解析后可能会引入新的 Property 需要再次 attach 使其生效</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurationPropertySources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">attach</span><span style="color:#ABB2BF;">(environment);</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> ConfigurableEnvironment</span><span style="color:#61AFEF;"> getOrCreateEnvironment</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">environment</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">environment</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里会根据 Web 环境动态创建 ConfigurableEnvironment</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableEnvironment</span><span style="color:#E06C75;"> environment </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationContextFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">createEnvironment</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">webApplicationType</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (environment </span><span style="color:#56B6C2;">==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationContextFactory</span><span style="color:#56B6C2;"> !=</span><span style="color:#E5C07B;"> ApplicationContextFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">DEFAULT</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E06C75;">        environment </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> ApplicationContextFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">DEFAULT</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">createEnvironment</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">webApplicationType</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> (environment </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#E06C75;"> environment </span><span style="color:#C678DD;">:</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ApplicationEnvironment</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> configureEnvironment</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableEnvironment</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里默认添加一个变量解析转换器</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">addConversionService</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        environment</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setConversionService</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ApplicationConversionService</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取配置文件，和命令行参数。后者会覆盖前者</span></span>
<span class="line"><span style="color:#61AFEF;">    configurePropertySources</span><span style="color:#E06C75;">(environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> args)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里只有通过编程式的添加 profiles 才会生效</span></span>
<span class="line"><span style="color:#61AFEF;">    configureProfiles</span><span style="color:#E06C75;">(environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> args)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> configurePropertySources</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableEnvironment</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;">[] args) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取配置信息</span></span>
<span class="line"><span style="color:#E5C07B;">    MutablePropertySources</span><span style="color:#E06C75;"> sources </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> environment</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getPropertySources</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 与默认的配置整合（缺少的补充，这里相同的不会覆盖）</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">CollectionUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">defaultProperties</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        DefaultPropertiesPropertySource</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addOrMerge</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">defaultProperties</span><span style="color:#ABB2BF;">, sources);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 解析命令行参数，相同的直接覆盖</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">addCommandLineProperties</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> args</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#D19A66;"> 0</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#E06C75;"> name </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> CommandLinePropertySource</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">COMMAND_LINE_PROPERTY_SOURCE_NAME</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">sources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contains</span><span style="color:#ABB2BF;">(name)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            PropertySource</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> source </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> sources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(name);</span></span>
<span class="line"><span style="color:#E5C07B;">            CompositePropertySource</span><span style="color:#E06C75;"> composite </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> CompositePropertySource</span><span style="color:#E06C75;">(name)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            composite</span></span>
<span class="line"><span style="color:#ABB2BF;">            .</span><span style="color:#61AFEF;">addPropertySource</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> SimpleCommandLinePropertySource</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;springApplicationCommandLineArgs&quot;</span><span style="color:#ABB2BF;">, args));</span></span>
<span class="line"><span style="color:#E5C07B;">            composite</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addPropertySource</span><span style="color:#ABB2BF;">(source);</span></span>
<span class="line"><span style="color:#E5C07B;">            sources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">replace</span><span style="color:#ABB2BF;">(name, composite);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            sources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addFirst</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> SimpleCommandLinePropertySource</span><span style="color:#ABB2BF;">(args));</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> Banner</span><span style="color:#61AFEF;"> printBanner</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableEnvironment</span><span style="color:#E06C75;"> environment) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 判断是否输出 Banner</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">bannerMode</span><span style="color:#56B6C2;"> ==</span><span style="color:#E5C07B;"> Banner</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Mode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">OFF</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#D19A66;"> null</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取资源类加载器</span></span>
<span class="line"><span style="color:#E5C07B;">    ResourceLoader</span><span style="color:#E06C75;"> resourceLoader </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) </span><span style="color:#C678DD;">?</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span></span>
<span class="line"><span style="color:#C678DD;">    :</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> DefaultResourceLoader</span><span style="color:#E06C75;">(</span><span style="color:#D19A66;">null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 创建 SpringApplicationBannerPrinter 对象用于保存 Banner 配置</span></span>
<span class="line"><span style="color:#E5C07B;">    SpringApplicationBannerPrinter</span><span style="color:#E06C75;"> bannerPrinter </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> SpringApplicationBannerPrinter</span><span style="color:#E06C75;">(resourceLoader</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">banner</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 至少输出到控制台如果赔了日志则输出到日志</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">bannerMode</span><span style="color:#56B6C2;"> ==</span><span style="color:#E5C07B;"> Mode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">LOG</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> bannerPrinter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">print</span><span style="color:#ABB2BF;">(environment, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mainApplicationClass</span><span style="color:#ABB2BF;">, logger);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> bannerPrinter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">print</span><span style="color:#ABB2BF;">(environment, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">mainApplicationClass</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">System</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">out</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">Banner</span><span style="color:#61AFEF;"> print</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Environment</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Class</span><span style="color:#56B6C2;">&lt;</span><span style="color:#C678DD;">?</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> sourceClass</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> PrintStream</span><span style="color:#E06C75;"> out) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过配置获取 Banner</span></span>
<span class="line"><span style="color:#E5C07B;">    Banner</span><span style="color:#E06C75;"> banner </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getBanner</span><span style="color:#E06C75;">(environment)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里会把所以定义的 Banner 都输出</span></span>
<span class="line"><span style="color:#E5C07B;">    banner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">printBanner</span><span style="color:#ABB2BF;">(environment, sourceClass, out);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 包装后返回，Banner 最后要注册到容器中</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> PrintedBanner</span><span style="color:#E06C75;">(banner</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sourceClass)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#E5C07B;"> Banner</span><span style="color:#61AFEF;"> getBanner</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Environment</span><span style="color:#E06C75;"> environment) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这个 Banners 是继承 Banner 的（其实就是用 List 包了多个 Banner）</span></span>
<span class="line"><span style="color:#E5C07B;">    Banners</span><span style="color:#E06C75;"> banners </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> Banners</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取图片 Banner 通过 spring.banner.image.location 指定，如未指定则加载 resources 下</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // gif, jpg, png 后缀的文件</span></span>
<span class="line"><span style="color:#E5C07B;">    banners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addIfNotNull</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getImageBanner</span><span style="color:#ABB2BF;">(environment));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果指定了 spring.banner.location 则首先加载，否则默认加载 resources 下 的 banner.txt</span></span>
<span class="line"><span style="color:#E5C07B;">    banners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addIfNotNull</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getTextBanner</span><span style="color:#ABB2BF;">(environment));</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">banners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hasAtLeastOneBanner</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E06C75;"> banners</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">fallbackBanner</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        return</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">fallbackBanner</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果都为定义，则返回默认的 banner，就是什么都不配置的那款（它是直接在类中用字符串定义的）</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> DEFAULT_BANNER</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> prepareContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">DefaultBootstrapContext</span><span style="color:#E06C75;"> bootstrapContext</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> ConfigurableApplicationContext</span><span style="color:#E06C75;"> context</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                            ConfigurableEnvironment</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> SpringApplicationRunListeners</span><span style="color:#E06C75;"> listeners</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">                            ApplicationArguments</span><span style="color:#E06C75;"> applicationArguments</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Banner</span><span style="color:#E06C75;"> printedBanner) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置环境</span></span>
<span class="line"><span style="color:#E5C07B;">    context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEnvironment</span><span style="color:#ABB2BF;">(environment);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里并没有触发钩子调用，这是注册 Spring 内部需要的 Bean 以及设置类加载器</span></span>
<span class="line"><span style="color:#61AFEF;">    postProcessApplicationContext</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 调用注册的 ApplicationContextInitializer 中的 initialize 方法</span></span>
<span class="line"><span style="color:#61AFEF;">    applyInitializers</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 发布 ApplicationContextInitializedEvent 事件</span></span>
<span class="line"><span style="color:#E5C07B;">    listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contextPrepared</span><span style="color:#ABB2BF;">(context);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过发布事件 BootstrapContextClosedEvent 关闭 BootstrapRegistry</span></span>
<span class="line"><span style="color:#E5C07B;">    bootstrapContext</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(context);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 输出启动性能分析日志</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">logStartupInfo</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">        logStartupInfo</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getParent</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        logStartupProfileInfo</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Add boot specific singleton beans</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanFactory</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 将启动参数 Bean 注册到容器中</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;springApplicationArguments&quot;</span><span style="color:#ABB2BF;">, applicationArguments);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 将 Banner 注册到容器中</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (printedBanner </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;springBootBanner&quot;</span><span style="color:#ABB2BF;">, printedBanner);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果允许循环依赖</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (beanFactory </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> AbstractAutowireCapableBeanFactory) {</span></span>
<span class="line"><span style="color:#E06C75;">        ((AbstractAutowireCapableBeanFactory) beanFactory)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setAllowCircularReferences</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">allowCircularReferences</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (beanFactory </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> DefaultListableBeanFactory) {</span></span>
<span class="line"><span style="color:#E06C75;">            ((DefaultListableBeanFactory) beanFactory)</span></span>
<span class="line"><span style="color:#ABB2BF;">            .</span><span style="color:#61AFEF;">setAllowBeanDefinitionOverriding</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">allowBeanDefinitionOverriding</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果是懒加载则添加懒加载处理 BeanFactoryPostProcessor</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">lazyInitialization</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanFactoryPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> LazyInitializationBeanFactoryPostProcessor</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 添加资源文件顺序处理 BeanFactoryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B;">    context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanFactoryPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> PropertySourceOrderingBeanFactoryPostProcessor</span><span style="color:#ABB2BF;">(context));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Load the sources</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 获取主类、子包和自定义的包作为扫描点</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Object</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> sources </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getAllSources</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">notEmpty</span><span style="color:#ABB2BF;">(sources, </span><span style="color:#98C379;">&quot;Sources must not be empty&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 加载主类、子包和自定义的包下的所有 Bean 将其注册为 BeanDefinition</span></span>
<span class="line"><span style="color:#61AFEF;">    load</span><span style="color:#E06C75;">(context</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> sources</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toArray</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#E5C07B;"> Object</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">])</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 发布 ApplicationPreparedEvent 事件</span></span>
<span class="line"><span style="color:#E5C07B;">    listeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contextLoaded</span><span style="color:#ABB2BF;">(context);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> CONFIGURATION_BEAN_NAME_GENERATOR </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#98C379;">&quot;org.springframework.context.annotation.internalConfigurationBeanNameGenerator&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> postProcessApplicationContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#E06C75;"> context) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注册 Bean 的别名生成器</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanNameGenerator</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanFactory</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">AnnotationConfigUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">CONFIGURATION_BEAN_NAME_GENERATOR</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanNameGenerator</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置资源类加载器和类加载器</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (context </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> GenericApplicationContext) {</span></span>
<span class="line"><span style="color:#E06C75;">            ((GenericApplicationContext) context)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setResourceLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (context </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> DefaultResourceLoader) {</span></span>
<span class="line"><span style="color:#E06C75;">            ((DefaultResourceLoader) context)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getClassLoader</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置类型转换器</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">addConversionService</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanFactory</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">setConversionService</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getEnvironment</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getConversionService</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> load</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ApplicationContext</span><span style="color:#E06C75;"> context</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Object</span><span style="color:#E06C75;">[] sources) {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isDebugEnabled</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">debug</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Loading source &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> StringUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">arrayToCommaDelimitedString</span><span style="color:#ABB2BF;">(sources));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 创建 BeanDefinition 加载器</span></span>
<span class="line"><span style="color:#E5C07B;">    BeanDefinitionLoader</span><span style="color:#E06C75;"> loader </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> createBeanDefinitionLoader</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">getBeanDefinitionRegistry</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sources)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanNameGenerator</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        loader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setBeanNameGenerator</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanNameGenerator</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        loader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setResourceLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">resourceLoader</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">environment</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        loader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setEnvironment</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">environment</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 使用上面创建的加载器对不同的资源进行加载</span></span>
<span class="line"><span style="color:#E5C07B;">    loader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">load</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#E5C07B;"> BeanDefinitionLoader</span><span style="color:#61AFEF;"> createBeanDefinitionLoader</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Object</span><span style="color:#E06C75;">[] sources) {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> BeanDefinitionLoader</span><span style="color:#E06C75;">(registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sources)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">BeanDefinitionLoader</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistry</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> Object</span><span style="color:#ABB2BF;">...</span><span style="color:#E5C07B;"> sources</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">notNull</span><span style="color:#ABB2BF;">(registry, </span><span style="color:#98C379;">&quot;Registry must not be null&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    Assert</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">notEmpty</span><span style="color:#ABB2BF;">(sources, </span><span style="color:#98C379;">&quot;Sources must not be empty&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">sources</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> sources</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取注解</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">annotatedReader</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> AnnotatedBeanDefinitionReader</span><span style="color:#E06C75;">(registry)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取 xml</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">xmlReader</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> (XML_ENABLED </span><span style="color:#C678DD;">?</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> XmlBeanDefinitionReader</span><span style="color:#E06C75;">(registry) </span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取 groovy 脚本</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">groovyReader</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">isGroovyPresent</span><span style="color:#E06C75;">() </span><span style="color:#C678DD;">?</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> GroovyBeanDefinitionReader</span><span style="color:#E06C75;">(registry) </span><span style="color:#C678DD;">:</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取类文件</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanner</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ClassPathBeanDefinitionScanner</span><span style="color:#E06C75;">(registry)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 标注哪些类无需读取的过滤器</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addExcludeFilter</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ClassExcludeFilter</span><span style="color:#ABB2BF;">(sources));</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="ioc-容器刷新" tabindex="-1"><a class="header-anchor" href="#ioc-容器刷新"><span>IOC 容器刷新</span></a></h1><p>refreshContext 首先会通过 Java API 注册一个 JVM 停机之前调用的钩子函数，然后才是实际的 refresh</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> refreshContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#E06C75;"> context) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注册钩子方法</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">registerShutdownHook</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        shutdownHook</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerApplicationContext</span><span style="color:#ABB2BF;">(context);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实际刷新动作</span></span>
<span class="line"><span style="color:#61AFEF;">    refresh</span><span style="color:#E06C75;">(context)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">void</span><span style="color:#61AFEF;"> registerApplicationContext</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#E06C75;"> context) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 如果没有注册 ShutdownHook 则注册</span></span>
<span class="line"><span style="color:#61AFEF;">    addRuntimeShutdownHookIfNecessary</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 添加 Spring Boot 应用停机监听器 ApplicationContextClosedListener</span></span>
<span class="line"><span style="color:#C678DD;">    synchronized</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">SpringApplicationShutdownHook</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">        assertNotInProgress</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">        context</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addApplicationListener</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">contextCloseListener</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">contexts</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(context);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> addRuntimeShutdownHookIfNecessary</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // CAS 添加防止注册多个</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">shutdownHookAdded</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSet</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">        addRuntimeShutdownHook</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">void</span><span style="color:#61AFEF;"> addRuntimeShutdownHook</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 调用 API 添加当前类，那么实际运行的就是 run 方法</span></span>
<span class="line"><span style="color:#E5C07B;">        Runtime</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRuntime</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">addShutdownHook</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> Thread</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;SpringApplicationShutdownHook&quot;</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">AccessControlException</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // Not allowed in some environments</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> run</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 流程很简单就是将注册的上下文和定义好的管不上下文函数都循环执行一遍</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> contexts</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> closedContexts</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Runnable</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> actions</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    synchronized</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">SpringApplicationShutdownHook</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">inProgress</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        contexts </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">contexts</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        closedContexts </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">closedContexts</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        actions </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">handlers</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getActions</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    contexts</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forEach</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">closeAndWait);</span></span>
<span class="line"><span style="color:#E5C07B;">    closedContexts</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forEach</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">closeAndWait);</span></span>
<span class="line"><span style="color:#E5C07B;">    actions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">forEach</span><span style="color:#ABB2BF;">(Runnable</span><span style="color:#C678DD;">::</span><span style="color:#ABB2BF;">run);</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>refresh 核心：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> refresh</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableApplicationContext</span><span style="color:#E06C75;"> applicationContext) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里是 org.springframework.context.support.AbstractApplicationContext</span></span>
<span class="line"><span style="color:#E5C07B;">    applicationContext</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">refresh</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> refresh</span><span style="color:#E06C75;">() throws BeansException</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> IllegalStateException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 加锁初始化（该方法可能被多个线程在不同的时期调用）</span></span>
<span class="line"><span style="color:#C678DD;">    synchronized</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">startupShutdownMonitor</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 记录开始初始化</span></span>
<span class="line"><span style="color:#E5C07B;">        StartupStep</span><span style="color:#E06C75;"> contextRefresh </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationStartup</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">start</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;spring.context.refresh&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 初始化前的预处理</span></span>
<span class="line"><span style="color:#61AFEF;">        prepareRefresh</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 获取 BeanFactory 加载所有的 BeanDefinition（就是设置了一下 BeanFactory 的序列化 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // ID 然后返回了）</span></span>
<span class="line"><span style="color:#E5C07B;">        ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> obtainFreshBeanFactory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 设置 BeanFactory 预处理配置</span></span>
<span class="line"><span style="color:#61AFEF;">        prepareBeanFactory</span><span style="color:#E06C75;">(beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        try</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 准备 BeanFactory 完成后进行的后置处理</span></span>
<span class="line"><span style="color:#61AFEF;">            postProcessBeanFactory</span><span style="color:#E06C75;">(beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 记录 beanPostProcess 开始调用</span></span>
<span class="line"><span style="color:#E5C07B;">            StartupStep</span><span style="color:#E06C75;"> beanPostProcess </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationStartup</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">start</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;spring.context.beans.post-process&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 执行 BeanFactory 创建后的后置处理</span></span>
<span class="line"><span style="color:#61AFEF;">            invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 注册 Bean 的后置处理器</span></span>
<span class="line"><span style="color:#61AFEF;">            registerBeanPostProcessors</span><span style="color:#E06C75;">(beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 记录 beanPostProcess 完成</span></span>
<span class="line"><span style="color:#E5C07B;">            beanPostProcess</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">end</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 初始化 MessageSource（国际化使用）</span></span>
<span class="line"><span style="color:#61AFEF;">            initMessageSource</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 初始化事件广播器</span></span>
<span class="line"><span style="color:#61AFEF;">            initApplicationEventMulticaster</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 提供给子类进行拓展的 onRefresh 方法</span></span>
<span class="line"><span style="color:#61AFEF;">            onRefresh</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 注册监听器</span></span>
<span class="line"><span style="color:#61AFEF;">            registerListeners</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 到这里 BeanFactory 创建完成</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 初始化所有剩下的非标记延迟初始化的单例 Bean 对象</span></span>
<span class="line"><span style="color:#61AFEF;">            finishBeanFactoryInitialization</span><span style="color:#E06C75;">(beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 完成容器创建（通过发布事件通知）</span></span>
<span class="line"><span style="color:#61AFEF;">            finishRefresh</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        catch</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">BeansException</span><span style="color:#E06C75;font-style:italic;"> ex</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isWarnEnabled</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">warn</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Exception encountered during context initialization - &quot;</span><span style="color:#56B6C2;"> +</span></span>
<span class="line"><span style="color:#98C379;">                            &quot;cancelling refresh attempt: &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#ABB2BF;"> ex);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 如果有异常则销毁所有创建的 Bean</span></span>
<span class="line"><span style="color:#61AFEF;">            destroyBeans</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 取消刷新</span></span>
<span class="line"><span style="color:#61AFEF;">            cancelRefresh</span><span style="color:#E06C75;">(ex)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 抛出异常终止</span></span>
<span class="line"><span style="color:#C678DD;">            throw</span><span style="color:#E06C75;"> ex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        finally</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 清除缓存</span></span>
<span class="line"><span style="color:#61AFEF;">            resetCommonCaches</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 记录容器刷新完成</span></span>
<span class="line"><span style="color:#E5C07B;">            contextRefresh</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">end</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> prepareRefresh</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 记录容器开始刷新的时间戳</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">startupDate</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> System</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">currentTimeMillis</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 标记当前 IOC 容器已经激活</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">closed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">active</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isDebugEnabled</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTraceEnabled</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">trace</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Refreshing &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            logger</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">debug</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Refreshing &quot;</span><span style="color:#56B6C2;"> +</span><span style="color:#61AFEF;"> getDisplayName</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 初始化属性配置</span></span>
<span class="line"><span style="color:#61AFEF;">    initPropertySources</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 属性校验（基本没有什么具体操作）</span></span>
<span class="line"><span style="color:#61AFEF;">    getEnvironment</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">validateRequiredProperties</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 监听器初始化（一些 IOC 容器可以反复刷新，所以要重置监听器）</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">earlyApplicationListeners</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">earlyApplicationListeners</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationListeners</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationListeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clear</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">applicationListeners</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addAll</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">earlyApplicationListeners</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 初始化早期事件的集合</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">earlyApplicationEvents</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> LinkedHashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> initPropertySources</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableEnvironment</span><span style="color:#E06C75;"> env </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> getEnvironment</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (env </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ConfigurableWebEnvironment) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 将 servletContex 和 servletConfig 包装成 PropertySource 方便统一读取</span></span>
<span class="line"><span style="color:#E06C75;">        ((ConfigurableWebEnvironment) env)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">initPropertySources</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">servletContext</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">protected</span><span style="color:#E5C07B;"> ConfigurableListableBeanFactory</span><span style="color:#61AFEF;"> obtainFreshBeanFactory</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实际啥也没干，只是设置了一下 BeanFactory 的序列化 ID </span></span>
<span class="line"><span style="color:#61AFEF;">    refreshBeanFactory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#61AFEF;"> getBeanFactory</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 这里是 org.springframework.context.support.GenericApplicationContext#refreshBeanFactory</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 也就是不允许重复刷新的 ApplicationContext</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 如果是 xml 驱动的，则调用 org.springframework.context.support.AbstractRefreshableApplicationContext#refreshBeanFactory</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 可以重复刷新，具体流程是先销毁已有的 BeanFactory 然后再重新组合父 BeanFactory 创建新的 BeanFactory</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 接着加载 xml 的 Bean 形成 BeanDefinition</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> refreshBeanFactory</span><span style="color:#E06C75;">() throws IllegalStateException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // CAS 修改刷新标识 </span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">refreshed</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">compareAndSet</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        throw</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> IllegalStateException</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#98C379;">            &quot;GenericApplicationContext does not support multiple refresh attempts: just call &#39;refresh&#39; once&quot;</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置序列化 ID</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setSerializationId</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getId</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> final</span><span style="color:#C678DD;"> boolean</span><span style="color:#E06C75;"> shouldIgnoreSpel </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> SpringProperties</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getFlag</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;spring.spel.ignore&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> prepareBeanFactory</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置 BanFactory 类加载器 </span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setBeanClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getClassLoader</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置表达式解析器（spring.spel.ignore 通过参数开关）</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">shouldIgnoreSpel) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setBeanExpressionResolver</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> StandardBeanExpressionResolver</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanClassLoader</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 设置属性编译器</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addPropertyEditorRegistrar</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ResourceEditorRegistrar</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">getEnvironment</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 添加 BeanPostProcessor 注入对应的 ApplicationContext</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ApplicationContextAwareProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 下面这些类既有 BeanPostProcessor 增强方法，又有 BeanFactory 的自动注入，调用</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ignoreDependencyInterface 后表示忽略自动注入方法</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 实现比较简单，就是将这些类添加到集合中，待到触发调用时按照对集合进行匹配忽略（Set 集合）</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">EnvironmentAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">EmbeddedValueResolverAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ResourceLoaderAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ApplicationEventPublisherAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MessageSourceAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ApplicationContextAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ApplicationStartupAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里相当于快速解析直接把 BeanFactory、ResourceLoader、ApplicationEventPublisher</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ApplicationContext 都解析成自身，用于支持自动注入时快速判断，实际就是添加到</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ConcurrentHashMap 中建立映射</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, beanFactory);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ResourceLoader</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ApplicationEventPublisher</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ApplicationContext</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 用于加载监听器（当前 ApplicationContext 如果是 Listener 则直接添加到 Listener 集合）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里分两种：一种是纯粹的 Listener，另一种是 ApplicationEventMulticaster（即是监听器</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 也是事件发布器）</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ApplicationListenerDetector</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // LoadTimeWeaver 支持</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">NativeDetector</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">inNativeImage</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsBean</span><span style="color:#ABB2BF;">(LOAD_TIME_WEAVER_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> LoadTimeWeaverAwareProcessor</span><span style="color:#ABB2BF;">(beanFactory));</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setTempClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ContextTypeMatchClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanClassLoader</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 将 Environment、系统配置、系统环境 也注册成为 Bean</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsLocalBean</span><span style="color:#ABB2BF;">(ENVIRONMENT_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(ENVIRONMENT_BEAN_NAME, </span><span style="color:#61AFEF;">getEnvironment</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsLocalBean</span><span style="color:#ABB2BF;">(SYSTEM_PROPERTIES_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(SYSTEM_PROPERTIES_BEAN_NAME, </span><span style="color:#61AFEF;">getEnvironment</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getSystemProperties</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsLocalBean</span><span style="color:#ABB2BF;">(SYSTEM_ENVIRONMENT_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(SYSTEM_ENVIRONMENT_BEAN_NAME, </span><span style="color:#61AFEF;">getEnvironment</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">getSystemEnvironment</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsLocalBean</span><span style="color:#ABB2BF;">(APPLICATION_STARTUP_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerSingleton</span><span style="color:#ABB2BF;">(APPLICATION_STARTUP_BEAN_NAME, </span><span style="color:#61AFEF;">getApplicationStartup</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 这里实际调用的是 org.springframework.boot.web.servlet.context.AnnotationConfigServletWebApplicationContext#postProcessBeanFactory</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// AnnotationConfigServletWebApplicationContext 之前在 ApplicationContext 创建时就确认了</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 其构造方法添加了 AnnotatedBeanDefinitionReader 和 ClassPathBeanDefinitionScanner</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> postProcessBeanFactory</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 触发父类回调</span></span>
<span class="line"><span style="color:#E5C07B;">    super</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">postProcessBeanFactory</span><span style="color:#ABB2BF;">(beanFactory);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 通过指定类路径扫描组件</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">ObjectUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">basePackages</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scanner</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">scan</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">basePackages</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 解析配置类</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">annotatedClasses</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isEmpty</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">reader</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">register</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ClassUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">toClassArray</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">annotatedClasses</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> postProcessBeanFactory</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注册 ServletContext 注册回调</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> WebApplicationContextServletContextAwareProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">this</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ignoreDependencyInterface</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ServletContextAware</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注册 Web 相关作用域</span></span>
<span class="line"><span style="color:#61AFEF;">    registerWebApplicationScopes</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 回调注入 ServletContext、ServletConfig</span></span>
<span class="line"><span style="color:#ABB2BF;">@</span><span style="color:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#E5C07B;"> Object</span><span style="color:#61AFEF;"> postProcessBeforeInitialization</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">Object</span><span style="color:#E06C75;"> bean</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> String</span><span style="color:#E06C75;"> beanName) throws BeansException {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">getServletContext</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> bean </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ServletContextAware) {</span></span>
<span class="line"><span style="color:#E06C75;">        ((ServletContextAware) bean)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setServletContext</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getServletContext</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#61AFEF;">getServletConfig</span><span style="color:#E06C75;">() </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E06C75;"> bean </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> ServletConfigAware) {</span></span>
<span class="line"><span style="color:#E06C75;">        ((ServletConfigAware) bean)</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setServletConfig</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getServletConfig</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> bean</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 注册 WebApplication 应用作用域</span></span>
<span class="line"><span style="color:#C678DD;">private</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerWebApplicationScopes</span><span style="color:#E06C75;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">    ExistingWebApplicationScopes</span><span style="color:#E06C75;"> existingScopes </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ExistingWebApplicationScopes</span><span style="color:#E06C75;">(</span><span style="color:#61AFEF;">getBeanFactory</span><span style="color:#E06C75;">())</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    WebApplicationContextUtils</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerWebApplicationScopes</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">getBeanFactory</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">    existingScopes</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">restore</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#61AFEF;"> ExistingWebApplicationScopes</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory) {</span></span>
<span class="line"><span style="color:#E5C07B;">    this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> beanFactory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> scopeName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> SCOPES) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 获取已经定义过的作用域</span></span>
<span class="line"><span style="color:#E5C07B;">        Scope</span><span style="color:#E06C75;"> scope </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getRegisteredScope</span><span style="color:#ABB2BF;">(scopeName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 添加已经定义过的作用域</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (scope </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            this</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">scopes</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(scopeName, scope);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerWebApplicationScopes</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">                                                @</span><span style="color:#E5C07B;">Nullable</span><span style="color:#E5C07B;"> ServletContext</span><span style="color:#E06C75;"> sc) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注册默认 Web 应用作用域策略</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerScope</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">WebApplicationContext</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SCOPE_REQUEST</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> RequestScope</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerScope</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">WebApplicationContext</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SCOPE_SESSION</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> SessionScope</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 默认情况下 APPLICATION 作用域不会注册</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (sc </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> null</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        ServletContextScope</span><span style="color:#E06C75;"> appScope </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#61AFEF;"> ServletContextScope</span><span style="color:#E06C75;">(sc)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerScope</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">WebApplicationContext</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">SCOPE_APPLICATION</span><span style="color:#ABB2BF;">, appScope);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // Register as ServletContext attribute, for ContextCleanupListener to detect it.</span></span>
<span class="line"><span style="color:#E5C07B;">        sc</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setAttribute</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ServletContextScope</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getName</span><span style="color:#ABB2BF;">(), appScope);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 依赖注入支持</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ServletRequest</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> RequestObjectFactory</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">ServletResponse</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ResponseObjectFactory</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">HttpSession</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> SessionObjectFactory</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerResolvableDependency</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">WebRequest</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> WebRequestObjectFactory</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (jsfPresent) {</span></span>
<span class="line"><span style="color:#E5C07B;">        FacesDependencyRegistrar</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">registerFacesDependencies</span><span style="color:#ABB2BF;">(beanFactory);</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">protected</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 执行 BeanFactory 后置处理器</span></span>
<span class="line"><span style="color:#E5C07B;">    PostProcessorRegistrationDelegate</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">invokeBeanFactoryPostProcessors</span><span style="color:#ABB2BF;">(beanFactory, </span><span style="color:#61AFEF;">getBeanFactoryPostProcessors</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // AOP 支持（后续单独详解）</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">NativeDetector</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">inNativeImage</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getTempClassLoader</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> null</span><span style="color:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">containsBean</span><span style="color:#ABB2BF;">(LOAD_TIME_WEAVER_BEAN_NAME)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> LoadTimeWeaverAwareProcessor</span><span style="color:#ABB2BF;">(beanFactory));</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">setTempClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ContextTypeMatchClassLoader</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanClassLoader</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 参数中的 beanFactoryPostProcessors 指的是通过编程的方式注入的</span></span>
<span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> List</span><span style="color:#56B6C2;">&lt;</span><span style="color:#E06C75;">BeanFactoryPostProcessor</span><span style="color:#56B6C2;">&gt;</span><span style="color:#E06C75;"> beanFactoryPostProcessors) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 已经触发过回调的 Bean 名称</span></span>
<span class="line"><span style="color:#E5C07B;">    Set</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> processedBeans </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> HashSet</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里必为 true，因为当前的 BeanFactory 只有一个落地实现 DefaultListableBeanFactory</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> (beanFactory </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> BeanDefinitionRegistry) {</span></span>
<span class="line"><span style="color:#E5C07B;">        BeanDefinitionRegistry</span><span style="color:#E06C75;"> registry </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> (BeanDefinitionRegistry) beanFactory</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 通过注解、配置文件等手段注入的常规类型 BeanFactoryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B;">        List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> regularPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 通过编程式注入的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B;">        List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> registryProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 如果是编程式注入的 BeanDefinitionRegistryPostProcessor 则直接触发 postProcessBeanDefinitionRegistry</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 调用，说明编程式优先级是最高的</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#E06C75;"> postProcessor </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> beanFactoryPostProcessors) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (postProcessor </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> BeanDefinitionRegistryPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B;">                BeanDefinitionRegistryPostProcessor</span><span style="color:#E06C75;"> registryProcessor </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#E06C75;">                (BeanDefinitionRegistryPostProcessor) postProcessor</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 触发 BeanDefinitionRegistryPostProcessor 的 postProcessBeanDefinitionRegistry 回调</span></span>
<span class="line"><span style="color:#E5C07B;">                registryProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">postProcessBeanDefinitionRegistry</span><span style="color:#ABB2BF;">(registry);</span></span>
<span class="line"><span style="color:#E5C07B;">                registryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(registryProcessor);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#C678DD;">            else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                regularPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(postProcessor);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 用于保存 BeanDefinitionRegistryPostProcessor 方便之后的排序，排序规则如下：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 按照实现 PriorityOrdered、Ordered、普通 接口依次触发回调</span></span>
<span class="line"><span style="color:#E5C07B;">        List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> currentRegistryProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 首先调用了实现 PriorityOrdered 接口的 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里直接从 beanFactory 中获取 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#E06C75;">[] postProcessorNames </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#E5C07B;">        beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanNamesForType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 添加 PriorityOrdered 级别的 BeanDefinitionRegistryPostProcessor 到 currentRegistryProcessors 中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 之后要排序</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">PriorityOrdered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 添加到当前调用集合</span></span>
<span class="line"><span style="color:#E5C07B;">                currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 添加到历史记录中</span></span>
<span class="line"><span style="color:#E5C07B;">                processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 按照从小到大的顺序排列（PriorityOrdered 继承 Ordered）</span></span>
<span class="line"><span style="color:#61AFEF;">        sortPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 该阶段可能注册新的 BeanDefinitionRegistryPostProcessor，需要添加到集合保存</span></span>
<span class="line"><span style="color:#E5C07B;">        registryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addAll</span><span style="color:#ABB2BF;">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 触发 BeanDefinitionRegistryPostProcessor 的 postProcessBeanDefinitionRegistry 方法回调</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里是实现 PriorityOrdered 接口的</span></span>
<span class="line"><span style="color:#61AFEF;">        invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getApplicationStartup</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 触发调用后清空当前记录（用于下阶段复用）</span></span>
<span class="line"><span style="color:#E5C07B;">        currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clear</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 获取实现 Ordered 接口的 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#E06C75;">        postProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanNamesForType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 添加 Ordered 级别的 BeanDefinitionRegistryPostProcessor 到 currentRegistryProcessors 中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 之后要排序</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contains</span><span style="color:#ABB2BF;">(ppName)</span><span style="color:#56B6C2;"> &amp;&amp;</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 添加到当前调用集合中</span></span>
<span class="line"><span style="color:#E5C07B;">                currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 添加到历史记录中</span></span>
<span class="line"><span style="color:#E5C07B;">                processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 按照从小到大的顺序排列（Ordered）</span></span>
<span class="line"><span style="color:#61AFEF;">        sortPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 该阶段可能注册新的 BeanDefinitionRegistryPostProcessor，需要添加到集合保存</span></span>
<span class="line"><span style="color:#E5C07B;">        registryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addAll</span><span style="color:#ABB2BF;">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 触发 BeanDefinitionRegistryPostProcessor 的 postProcessBeanDefinitionRegistry 方法回调</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里是实现 Ordered 接口的</span></span>
<span class="line"><span style="color:#61AFEF;">        invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getApplicationStartup</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 触发调用后清空当前记录（用于下阶段复用）</span></span>
<span class="line"><span style="color:#E5C07B;">        currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clear</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 最后调用没有实现 PriorityOrdered、Ordered 接口以及调用阶段新注册的 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 知道全部 BeanDefinitionRegistryPostProcessors 的 postProcessBeanDefinitionRegistry 方法</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 都调用完成（BeanDefinitionRegistryPostProcessors 的 postProcessBeanDefinitionRegistry 可能</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 会注册新的 BeanDefinitionRegistryPostProcessor 这里需要将新加入的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 也一并触发 postProcessBeanDefinitionRegistry 调用）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // reiterate 用于标记在调用 postProcessBeanDefinitionRegistry 方法时是否有新的</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // BeanDefinitionRegistryPostProcessor 注册</span></span>
<span class="line"><span style="color:#C678DD;">        boolean</span><span style="color:#E06C75;"> reiterate </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        while</span><span style="color:#E06C75;"> (reiterate) {</span></span>
<span class="line"><span style="color:#E06C75;">            reiterate </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            postProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanNamesForType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">            for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // processedBeans 保存了所有执行过的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 这里只添加未执行的</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contains</span><span style="color:#ABB2BF;">(ppName)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">                    currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E5C07B;">                    processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">                    reiterate </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">                }</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 依旧按照 PriorityOrdered、Ordered 进行排序</span></span>
<span class="line"><span style="color:#61AFEF;">            sortPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 该阶段可能注册新的 BeanDefinitionRegistryPostProcessor，需要添加到集合保存</span></span>
<span class="line"><span style="color:#E5C07B;">            registryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addAll</span><span style="color:#ABB2BF;">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 触发调用后清空当前记录（直到没有新的 BeanDefinitionRegistryPostProcessor 注册）</span></span>
<span class="line"><span style="color:#61AFEF;">            invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75;">(currentRegistryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> registry</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getApplicationStartup</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">            currentRegistryProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clear</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // registryProcessors 都是排好序的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // BeanFactoryPostProcessor 只涉及修改不会有新的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 添加，这里直接触发 postProcessBeanFactory 方法调用（手动注册依旧优先级最高）</span></span>
<span class="line"><span style="color:#61AFEF;">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(registryProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里的 regularPostProcessors 是通过注解或者 xml 等形式引入的，优先级低于手动编程注册</span></span>
<span class="line"><span style="color:#61AFEF;">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(regularPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 仅调用编程式注册的 beanFactoryPostProcessor（Spring Boot 下走不到这个分支）</span></span>
<span class="line"><span style="color:#61AFEF;">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(beanFactoryPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 上面调用的都是通过注册 BeanDefinitionRegistryPostProcessor 接口的，也有可能单独注册</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // BeanFactoryPostProcessor 的，需要再提取出来</span></span>
<span class="line"><span style="color:#E5C07B;">    String</span><span style="color:#E06C75;">[] postProcessorNames </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanNamesForType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里直接按照优先级 PriorityOrdered、Ordered 进行提取</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 首先是优先级最高的 PriorityOrdered</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> priorityOrderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 其次是 Ordered</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> orderedPostProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 最后是没有实现优先级接口的</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> nonOrderedPostProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 过滤之前已经调用过的</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">processedBeans</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">contains</span><span style="color:#ABB2BF;">(ppName)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // skip - already processed in first phase above</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">PriorityOrdered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            priorityOrderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            orderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            nonOrderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 首先调用 PriorityOrdered</span></span>
<span class="line"><span style="color:#61AFEF;">    sortPostProcessors</span><span style="color:#E06C75;">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 其次调用 Ordered</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> orderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">orderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> postProcessorName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B;">        orderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(postProcessorName, </span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    sortPostProcessors</span><span style="color:#E06C75;">(orderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(orderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 最后调用没有实现优先级接口的</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> nonOrderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">nonOrderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> postProcessorName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B;">        nonOrderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(postProcessorName, </span><span style="color:#E5C07B;">BeanFactoryPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75;">(nonOrderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 清空缓存</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clearMetadataCache</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">public</span><span style="color:#C678DD;"> static</span><span style="color:#C678DD;"> void</span><span style="color:#61AFEF;"> registerBeanPostProcessors</span><span style="color:#E06C75;">(</span></span>
<span class="line"><span style="color:#E5C07B;">    ConfigurableListableBeanFactory</span><span style="color:#E06C75;"> beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;"> AbstractApplicationContext</span><span style="color:#E06C75;"> applicationContext) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // WARNING: Although it may appear that the body of this method can be easily</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // refactored to avoid the use of multiple loops and multiple lists, the use</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // of multiple lists and multiple passes over the names of processors is</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // and Ordered processors. Specifically, we must NOT cause processors to be</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // in the wrong order.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Before submitting a pull request (PR) to change this method, please review the</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // to ensure that your proposal does not result in a breaking change:</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">    String</span><span style="color:#E06C75;">[] postProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanNamesForType</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Register BeanPostProcessorChecker that logs an info message when</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // a bean is created during BeanPostProcessor instantiation, i.e. when</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // a bean is not eligible for getting processed by all BeanPostProcessors.</span></span>
<span class="line"><span style="color:#C678DD;">    int</span><span style="color:#E06C75;"> beanProcessorTargetCount </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBeanPostProcessorCount</span><span style="color:#ABB2BF;">()</span><span style="color:#56B6C2;"> +</span><span style="color:#D19A66;"> 1</span><span style="color:#56B6C2;"> +</span><span style="color:#E5C07B;"> postProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">length</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> BeanPostProcessorChecker</span><span style="color:#ABB2BF;">(beanFactory, beanProcessorTargetCount));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Separate between BeanPostProcessors that implement PriorityOrdered,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Ordered, and the rest.</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> priorityOrderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> internalPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> orderedPostProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> nonOrderedPostProcessorNames </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">()</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">PriorityOrdered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            BeanPostProcessor</span><span style="color:#E06C75;"> pp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">            priorityOrderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> (pp </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B;">                internalPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#E06C75;">            }</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">isTypeMatch</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">Ordered</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">            orderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#C678DD;">        else</span><span style="color:#E06C75;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            nonOrderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(ppName);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // First, register the BeanPostProcessors that implement PriorityOrdered.</span></span>
<span class="line"><span style="color:#61AFEF;">    sortPostProcessors</span><span style="color:#E06C75;">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    registerBeanPostProcessors</span><span style="color:#E06C75;">(beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> priorityOrderedPostProcessors)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Next, register the BeanPostProcessors that implement Ordered.</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> orderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">orderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B;">        BeanPostProcessor</span><span style="color:#E06C75;"> pp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        orderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (pp </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B;">            internalPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    sortPostProcessors</span><span style="color:#E06C75;">(orderedPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    registerBeanPostProcessors</span><span style="color:#E06C75;">(beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> orderedPostProcessors)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Now, register all regular BeanPostProcessors.</span></span>
<span class="line"><span style="color:#E5C07B;">    List</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#E06C75;"> nonOrderedPostProcessors </span><span style="color:#56B6C2;">=</span><span style="color:#C678DD;"> new</span><span style="color:#E5C07B;"> ArrayList</span><span style="color:#ABB2BF;">&lt;&gt;</span><span style="color:#E06C75;">(</span><span style="color:#E5C07B;">nonOrderedPostProcessorNames</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">size</span><span style="color:#ABB2BF;">()</span><span style="color:#E06C75;">)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> (</span><span style="color:#E5C07B;">String</span><span style="color:#E06C75;"> ppName </span><span style="color:#C678DD;">:</span><span style="color:#E06C75;"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B;">        BeanPostProcessor</span><span style="color:#E06C75;"> pp </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getBean</span><span style="color:#ABB2BF;">(ppName, </span><span style="color:#E5C07B;">BeanPostProcessor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">class</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">        nonOrderedPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> (pp </span><span style="color:#C678DD;">instanceof</span><span style="color:#E06C75;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B;">            internalPostProcessors</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add</span><span style="color:#ABB2BF;">(pp);</span></span>
<span class="line"><span style="color:#E06C75;">        }</span></span>
<span class="line"><span style="color:#E06C75;">    }</span></span>
<span class="line"><span style="color:#61AFEF;">    registerBeanPostProcessors</span><span style="color:#E06C75;">(beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> nonOrderedPostProcessors)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Finally, re-register all internal BeanPostProcessors.</span></span>
<span class="line"><span style="color:#61AFEF;">    sortPostProcessors</span><span style="color:#E06C75;">(internalPostProcessors</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> beanFactory)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    registerBeanPostProcessors</span><span style="color:#E06C75;">(beanFactory</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> internalPostProcessors)</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // moving it to the end of the processor chain (for picking up proxies etc).</span></span>
<span class="line"><span style="color:#E5C07B;">    beanFactory</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">addBeanPostProcessor</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">new</span><span style="color:#61AFEF;"> ApplicationListenerDetector</span><span style="color:#ABB2BF;">(applicationContext));</span></span>
<span class="line"><span style="color:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!----><div class="vp-doc-copyright" data-v-e0bef33b><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-309da98c><a href="#doc-copyright" class="header-anchor" data-v-309da98c><span data-v-309da98c><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-2a9548e5><p data-v-2a9548e5><span data-v-2a9548e5>版权归属：</span><a class="vp-link no-icon link" href="https://github.com/upcloudrabbit" target="_blank" rel="noreferrer" data-v-2a9548e5 data-v-442a52aa><!--[-->upcloudrabbit<!--]--><!----></a></p><p data-v-2a9548e5><span data-v-2a9548e5>本文链接：</span><a class="vp-link no-icon link" href="/blog/article/i51fy95l/" data-allow-mismatch data-v-2a9548e5 data-v-442a52aa><!--[-->/article/i51fy95l/<!--]--><!----></a></p><p data-v-2a9548e5><span data-v-2a9548e5>许可证：</span><a class="vp-link no-icon link" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer" data-v-2a9548e5 data-v-442a52aa><!--[-->署名 4.0 国际 (CC-BY-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-2a9548e5></span><span class="vpi-license-by" data-v-2a9548e5></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-e0bef33b data-v-f7268517><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-f7268517><span class="contributors-label" data-v-f7268517>贡献者: </span><span class="contributors-info" data-v-f7268517><!--[--><!--[--><span class="contributor" data-v-f7268517>upcloudrabbit</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-f7268517><div class="pager" data-v-f7268517><a class="vp-link no-icon link pager-link prev" href="/blog/article/o4assejb/" data-v-f7268517 data-v-442a52aa><!--[--><span class="desc" data-v-f7268517>上一页</span><span class="title" data-v-f7268517>调试工具</span><!--]--><!----></a></div><div class="pager" data-v-f7268517><a class="vp-link no-icon link pager-link next" href="/blog/article/qf0239zm/" data-v-f7268517 data-v-442a52aa><!--[--><span class="desc" data-v-f7268517>下一页</span><span class="title" data-v-f7268517>jni</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-68cd6b44 data-v-f098172b><span class="percent" data-allow-mismatch data-v-f098172b>0%</span><span class="show icon vpi-back-to-top" data-v-f098172b></span><svg aria-hidden="true" data-v-f098172b><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-f098172b></circle></svg></button><footer class="vp-footer" vp-footer data-v-68cd6b44 data-v-400675cf><!--[--><div class="container" data-v-400675cf><p class="message" data-v-400675cf>Power by upcloudrabbit</p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/blog/assets/app-CJfFg5nr.js" defer></script></body></html>