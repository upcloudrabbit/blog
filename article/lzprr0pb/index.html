<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.19" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'dark';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><meta property="og:url" content="https://upcloudrabbit.github.io/blog/blog/article/lzprr0pb/"><meta property="og:site_name" content="upcloudrabbit blog"><meta property="og:title" content="mysql"><meta property="og:description" content="这里用两台机器作为演示，ip 分别为 192.168.6.100/192.168.6.101，如果是主从那么只做一台的配置即可，主主就是相当于做两次主从，即：192.168.6.100（master） <- 192.168.6.101（slave） 192.168.6.100（slave） -> 192.168.6.101（master） 首先下载 m..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-24T16:09:31.000Z"><meta property="article:tag" content="mysql"><meta property="article:tag" content="database"><meta property="article:modified_time" content="2025-02-24T16:09:31.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"mysql","image":[""],"dateModified":"2025-02-24T16:09:31.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>mysql | upcloudrabbit blog</title><meta name="description" content="这里用两台机器作为演示，ip 分别为 192.168.6.100/192.168.6.101，如果是主从那么只做一台的配置即可，主主就是相当于做两次主从，即：192.168.6.100（master） <- 192.168.6.101（slave） 192.168.6.100（slave） -> 192.168.6.101（master） 首先下载 m..."><link rel="preload" href="/blog/assets/style-BEcvEdyM.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BEcvEdyM.css"><link rel="modulepreload" href="/blog/assets/app-CJfFg5nr.js"><link rel="modulepreload" href="/blog/assets/index.html-WWlyfq_6.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-68cd6b44><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d5a8d0bc></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-d5a8d0bc> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-68cd6b44 data-v-d34f28d6><div class="vp-navbar" vp-navbar data-v-d34f28d6 data-v-70d97d16><div class="wrapper" data-v-70d97d16><div class="container" data-v-70d97d16><div class="title" data-v-70d97d16><div class="vp-navbar-title" data-v-70d97d16 data-v-2c8d4622><a class="vp-link no-icon link title" href="/blog/" data-v-2c8d4622 data-v-442a52aa><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" src="/blog/EditBlog.png" alt data-v-7fbfbc9b><!--]--><!--[--><img class="vp-image light logo" src="/blog/EditBlog.png" alt data-v-7fbfbc9b><!--]--><!--]--><!--]--><span data-v-2c8d4622>upcloudrabbit blog</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-70d97d16><div class="content-body" data-v-70d97d16><!--[--><!--]--><div class="vp-navbar-search search" data-v-70d97d16><div class="search-wrapper" data-v-97535d1e><!----><div id="local-search" data-v-97535d1e><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-97535d1e><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-70d97d16 data-v-d43c1732><span id="main-nav-aria-label" class="visually-hidden" data-v-d43c1732>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/categories/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>分类</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-d43c1732 data-v-9970a379 data-v-442a52aa><!--[--><!----><span data-v-9970a379>归档</span><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-70d97d16 data-v-a295abf6><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-a295abf6 data-v-596c25a9 data-v-d84fedac><span class="check" data-v-d84fedac><span class="icon" data-v-d84fedac><!--[--><span class="vpi-sun sun" data-v-596c25a9></span><span class="vpi-moon moon" data-v-596c25a9></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-70d97d16 data-v-ad52545c data-v-40bac536><!--[--><a class="vp-social-link no-icon" href="https://github.com/upcloudrabbit" aria-label="github" target="_blank" rel="noopener" data-v-40bac536 data-v-67b21932><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-70d97d16 data-v-652282fd data-v-feafea4e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-feafea4e><span class="vpi-more-horizontal icon" data-v-feafea4e></span></button><div class="menu" data-v-feafea4e><div class="vp-menu" data-v-feafea4e data-v-709dc2b1><!----><!--[--><!--[--><!----><div class="group" data-v-652282fd><div class="item appearance" data-v-652282fd><p class="label" data-v-652282fd>外观</p><div class="appearance-action" data-v-652282fd><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-652282fd data-v-596c25a9 data-v-d84fedac><span class="check" data-v-d84fedac><span class="icon" data-v-d84fedac><!--[--><span class="vpi-sun sun" data-v-596c25a9></span><span class="vpi-moon moon" data-v-596c25a9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-652282fd><div class="item social-links" data-v-652282fd><div class="vp-social-links social-links-list" data-v-652282fd data-v-40bac536><!--[--><a class="vp-social-link no-icon" href="https://github.com/upcloudrabbit" aria-label="github" target="_blank" rel="noopener" data-v-40bac536 data-v-67b21932><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-70d97d16 data-v-2b50024d><span class="container" data-v-2b50024d><span class="top" data-v-2b50024d></span><span class="middle" data-v-2b50024d></span><span class="bottom" data-v-2b50024d></span></span></button></div></div></div></div><div class="divider" data-v-70d97d16><div class="divider-line" data-v-70d97d16></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-68cd6b44 data-v-1dc3518c><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-1dc3518c><span class="vpi-align-left menu-icon" data-v-1dc3518c></span><span class="menu-text" data-v-1dc3518c>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-1dc3518c data-v-423a73ec><button data-v-423a73ec>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-68cd6b44 data-v-eb709286><div class="vp-doc-container is-blog" data-v-eb709286 data-v-e0bef33b><!--[--><!--]--><div class="container" data-v-e0bef33b><!----><div class="content" data-v-e0bef33b><div class="content-container" data-v-e0bef33b><!--[--><!--]--><main class="main" data-v-e0bef33b><nav class="vp-breadcrumb" data-v-e0bef33b data-v-1ae4ad7a><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-1ae4ad7a><!--[--><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-1ae4ad7a></span><meta property="name" content="首页" data-v-1ae4ad7a><meta property="position" content="1" data-v-1ae4ad7a></li><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb" href="/blog/categories/?id=d77d5e" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->db<!--]--><!----></a><span class="vpi-chevron-right" data-v-1ae4ad7a></span><meta property="name" content="db" data-v-1ae4ad7a><meta property="position" content="2" data-v-1ae4ad7a></li><li property="itemListElement" typeof="ListItem" data-v-1ae4ad7a><a class="vp-link no-icon link breadcrumb current" href="/blog/article/lzprr0pb/" property="item" typeof="WebPage" data-v-1ae4ad7a data-v-442a52aa><!--[-->mysql<!--]--><!----></a><!----><meta property="name" content="mysql" data-v-1ae4ad7a><meta property="position" content="3" data-v-1ae4ad7a></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-581be9b0>mysql <!----></h1><div class="vp-doc-meta" data-v-581be9b0><p class="reading-time" data-v-581be9b0><span class="vpi-books icon" data-v-581be9b0></span><span data-v-581be9b0>约 6667 字</span><span data-v-581be9b0>大约 22 分钟</span></p><p data-v-581be9b0><span class="vpi-tag icon" data-v-581be9b0></span><!--[--><a class="vp-link no-icon link tag vp-tag-5ly2" href="/blog/tags/?tag=mysql" data-v-581be9b0 data-v-442a52aa><!--[-->mysql<!--]--><!----></a><a class="vp-link no-icon link tag vp-tag-nnfx" href="/blog/tags/?tag=database" data-v-581be9b0 data-v-442a52aa><!--[-->database<!--]--><!----></a><!--]--></p><p class="create-time" data-v-581be9b0><span class="vpi-clock icon" data-v-581be9b0></span><span data-v-581be9b0>2025-02-24</span></p></div><!--]--><div class="_article_lzprr0pb_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-e0bef33b><div data-v-e0bef33b><p>这里用两台机器作为演示，ip 分别为 192.168.6.100/192.168.6.101，如果是主从那么只做一台的配置即可，主主就是相当于做两次主从，即：192.168.6.100（master） &lt;- 192.168.6.101（slave） 192.168.6.100（slave） -&gt; 192.168.6.101（master）</p><ol><li>首先下载 mysql8 <code>wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz</code></li><li>解压到指定目录 <code>tar -Jxf mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz -C /opt/softs &amp;&amp; mv mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz mysql-8.0.31</code></li><li>进入目录创建 logs、other 文件夹 <code>cd /usr/mpsp/mysql-8.0.31 &amp;&amp; mkdir logs other</code>不要创建 data 文件夹</li><li>编写 mysql 配置文件 <code>vim ./my.cnf</code>（另一台服务器修改对应的 server-id、auto_increment_offset）</li></ol><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">[client]</span></span>
<span class="line"><span style="color:#C678DD;">port</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 3306</span></span>
<span class="line"><span style="color:#C678DD;">socket</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/other/mysql.sock</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#61AFEF;">[mysqld]</span></span>
<span class="line"><span style="color:#C678DD;">port</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 3306</span></span>
<span class="line"><span style="color:#C678DD;">socket</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/other/mysql.sock</span></span>
<span class="line"><span style="color:#C678DD;">basedir</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31</span></span>
<span class="line"><span style="color:#C678DD;">datadir</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/data</span></span>
<span class="line"><span style="color:#C678DD;">pid-file</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/other/mysql.pid</span></span>
<span class="line"><span style="color:#C678DD;">user</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> mysql</span></span>
<span class="line"><span style="color:#C678DD;">bind-address</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 0.0.0.0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 一个集群内保证唯一即可</span></span>
<span class="line"><span style="color:#C678DD;">server-id</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 主键自增步长（为集群节点数量）</span></span>
<span class="line"><span style="color:#C678DD;">auto_increment_increment</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">2</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 主键自增起始值（为机器号）</span></span>
<span class="line"><span style="color:#C678DD;">auto_increment_offset</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">character-set-server</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> utf8mb4</span></span>
<span class="line"><span style="color:#C678DD;">collation-server</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> utf8mb4_general_ci</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#设置client连接mysql时的字符集,防止乱码</span></span>
<span class="line"><span style="color:#C678DD;">init_connect</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&#39;SET NAMES utf8mb4&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#TIMESTAMP如果没有显示声明NOT NULL，允许NULL值</span></span>
<span class="line"><span style="color:#C678DD;">explicit_defaults_for_timestamp</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> true</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">lower_case_table_names</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">1</span></span>
<span class="line"><span style="color:#98C379;">skip-name-resolve</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#skip-networking</span></span>
<span class="line"><span style="color:#C678DD;">back_log</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 600</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL能有的连接数量。当主要MySQL线程在一个很短时间内得到非常多的连接请求，这就起作用，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 然后主线程花些时间(尽管很短)检查连接并且启动一个新线程。back_log值指出在MySQL暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果期望在一个短时间内有很多连接，你需要增加它。也就是说，如果MySQL的连接数据达到max_connections时，新来的请求将会被存在堆栈中，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 以等待某一连接释放资源，该堆栈的数量即back_log，如果等待连接的数量超过back_log，将不被授予连接资源。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 另外，这值（back_log）限于您的操作系统对到来的TCP/IP连接的侦听队列的大小。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 你的操作系统在这个队列大小上有它自己的限制（可以检查你的OS文档找出这个变量的最大值），试图设定back_log高于你的操作系统的限制将是无效的。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">max_connections</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1000</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL的最大连接数，如果服务器的并发连接请求量比较大，建议调高此值，以增加并行连接数量，当然这建立在机器能支撑的情况下，因为如果连接数越多，介于MySQL会为每个连接提供连接缓冲区，就会开销越多的内存，所以要适当调整该值，不能盲目提高设值。可以过&#39;conn%&#39;通配符查看当前状态的连接数量，以定夺该值的大小。</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">max_connect_errors</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 6000</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 对于同一主机，如果有超出该参数值个数的中断错误连接，则该主机将被禁止连接。如需对该主机进行解禁，执行：FLUSH HOST。 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">open_files_limit</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 65535</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL打开的文件描述符限制，默认最小1024;当open_files_limit没有被配置的时候，比较max_connections*5和ulimit -n的值，哪个大用哪个，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 当open_file_limit被配置的时候，比较open_files_limit和max_connections*5的值，哪个大用哪个。</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">table_open_cache</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 128</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL每打开一个表，都会读入一些数据到table_open_cache缓存中，当MySQL在这个缓存中找不到相应信息时，才会去磁盘上读取。默认值64</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 假定系统有200个并发连接，则需将此参数设置为200*N(N为每个连接所需的文件描述符数目)；</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 当把table_open_cache设置为很大时，如果系统处理不了那么多文件描述符，那么就会出现客户端失效，连接不上</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">max_allowed_packet</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 接受的数据包大小；增加该变量的值十分安全，这是因为仅当需要时才会分配额外内存。例如，仅当你发出长查询或MySQLd必须返回大的结果行时MySQLd才会分配更多内存。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 该变量之所以取较小默认值是一种预防措施，以捕获客户端和服务器之间的错误信息包，并确保不会因偶然使用大的信息包而导致内存溢出。</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">binlog_cache_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 一个事务，在没有提交的时候，产生的日志，记录到Cache中；等到事务提交需要提交的时候，则把日志持久化到磁盘。默认binlog_cache_size大小32K</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">max_heap_table_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 定义了用户可以创建的内存表(memory table)的大小。这个值用来计算内存表的最大行数值。这个变量支持动态改变</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">tmp_table_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 16M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL的heap（堆积）表缓冲大小。所有联合在一个DML指令内完成，并且大多数联合甚至可以不用临时表即可以完成。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 大多数临时表是基于内存的(HEAP)表。具有大的记录长度的临时表 (所有列的长度的和)或包含BLOB列的表存储在硬盘上。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果某个内部heap（堆积）表大小超过tmp_table_size，MySQL可以根据需要自动将内存中的heap表改为基于硬盘的MyISAM表。还可以通过设置tmp_table_size选项来增加临时表的大小。也就是说，如果调高该值，MySQL同时将增加heap表的大小，可达到提高联接查询速度的效果</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">read_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 2M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">read_rnd_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL的随机读缓冲区大小。当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。但MySQL会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">sort_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL执行排序使用的缓冲大小。如果想要增加ORDER BY的速度，首先看是否可以让MySQL使用索引而不是额外的排序阶段。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果不能，可以尝试增加sort_buffer_size变量的大小</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">join_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 联合查询操作所能使用的缓冲区大小，和sort_buffer_size一样，该参数对应的分配内存也是每连接独享</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">thread_cache_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 64</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 这个值（默认8）表示可以重新利用保存在缓存中线程的数量，当断开连接时如果缓存中还有空间，那么客户端的线程将被放到缓存中，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果线程重新被请求，那么请求将从缓存中读取,如果缓存中是空的或者是新的请求，那么这个线程将被重新创建,如果有很多新的线程，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 增加这个值可以改善系统性能.通过比较Connections和Threads_created状态的变量，可以看到这个变量的作用。(–&gt;表示要调整的值)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 根据物理内存设置规则如下：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 1G  —&gt; 8</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 2G  —&gt; 16</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 3G  —&gt; 32</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 大于3G  —&gt; 64</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">key_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 512M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#指定用于索引的缓冲区大小，增加它可得到更好处理的索引(对所有读和多重写)，到你能负担得起那样多。如果你使它太大，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 系统将开始换页并且真的变慢了。对于内存在4GB左右的服务器该参数可设置为384M或512M。通过检查状态值Key_read_requests和Key_reads，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 可以知道key_buffer_size设置是否合理。比例key_reads/key_read_requests应该尽可能的低，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 至少是1:100，1:1000更好(上述状态值可以使用SHOW STATUS LIKE &#39;key_read%&#39;获得)。注意：该参数值设置的过大反而会是服务器整体效率降低</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">ft_min_word_len</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 分词词汇最小长度，默认4</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">transaction_isolation</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> REPEATABLE-READ</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL支持4种事务隔离级别，他们分别是：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># READ-UNCOMMITTED, READ-COMMITTED, REPEATABLE-READ, SERIALIZABLE.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如没有指定，MySQL默认采用的是REPEATABLE-READ，ORACLE默认的是READ-COMMITTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">log_bin</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> mysql-bin</span></span>
<span class="line"><span style="color:#C678DD;">binlog_format</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> mixed</span></span>
<span class="line"><span style="color:#C678DD;">binlog_expire_logs_seconds</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 2592000 </span><span style="color:#7F848E;font-style:italic;">#超过30天的binlog删除</span></span>
<span class="line"><span style="color:#C678DD;">log_error</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/logs/error.log </span><span style="color:#7F848E;font-style:italic;">#错误日志路径</span></span>
<span class="line"><span style="color:#C678DD;">slow_query_log</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1</span></span>
<span class="line"><span style="color:#C678DD;">long_query_time</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 3 </span><span style="color:#7F848E;font-style:italic;">#慢查询时间 超过3秒则为慢查询</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">slow_query_log_file</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/logs/slow-query.log</span></span>
<span class="line"><span style="color:#C678DD;">performance_schema</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 0</span></span>
<span class="line"><span style="color:#98C379;">explicit_defaults_for_timestamp</span></span>
<span class="line"><span style="color:#C678DD;">lower_case_table_names</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1 </span><span style="color:#7F848E;font-style:italic;">#不区分大小写 </span></span>
<span class="line"><span style="color:#98C379;">skip-external-locking </span><span style="color:#7F848E;font-style:italic;">#MySQL选项以避免外部锁定。该选项默认开启</span></span>
<span class="line"><span style="color:#C678DD;">default-storage-engine</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> InnoDB </span><span style="color:#7F848E;font-style:italic;">#默认存储引擎</span></span>
<span class="line"><span style="color:#C678DD;">innodb_file_per_table</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># InnoDB为独立表空间模式，每个数据库的每个表都会生成一个数据空间</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 独立表空间优点：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 1．每个表都有自已独立的表空间。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 2．每个表的数据和索引都会存在自已的表空间中。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 3．可以实现单表在不同的数据库中移动。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 4．空间可以回收（除drop table操作处，表空不能自已回收）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 缺点：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 单表增加过大，如超过100G</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 结论：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 共享表空间在Insert操作上少有优势。其它都没独立表空间表现好。当启用独立表空间时，请合理调整：innodb_open_files</span></span>
<span class="line"><span style="color:#C678DD;">innodb_open_files</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 500</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 限制Innodb能打开的表的数据，如果库里的表特别多的情况，请增加这个。这个值默认是300</span></span>
<span class="line"><span style="color:#C678DD;">innodb_buffer_pool_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 6G</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># InnoDB使用一个缓冲池来保存索引和原始数据, 不像MyISAM.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 这里你设置越大,你在存取表里面数据时所需要的磁盘I/O越少.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 在一个独立使用的数据库服务器上,你可以设置这个变量到服务器物理内存大小的80%</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 不要设置过大,否则,由于物理内存的竞争可能导致操作系统的换页颠簸.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 注意在32位系统上你每个进程可能被限制在 2-3.5G 用户层面内存限制,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 所以不要设置的太高.</span></span>
<span class="line"><span style="color:#C678DD;">innodb_write_io_threads</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4</span></span>
<span class="line"><span style="color:#C678DD;">innodb_read_io_threads</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># innodb使用后台线程处理数据页上的读写 I/O(输入输出)请求,根据你的 CPU 核数来更改,默认是4</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 注:这两个参数不支持动态改变,需要把该参数加入到my.cnf里，修改完后重启MySQL服务,允许值的范围从 1-64</span></span>
<span class="line"><span style="color:#C678DD;">innodb_thread_concurrency</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 默认设置为 0,表示不限制并发数，这里推荐设置为0，更好去发挥CPU多核处理能力，提高并发量</span></span>
<span class="line"><span style="color:#C678DD;">innodb_purge_threads</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># InnoDB中的清除操作是一类定期回收无用数据的操作。在之前的几个版本中，清除操作是主线程的一部分，这意味着运行时它可能会堵塞其它的数据库操作。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 从MySQL5.5.X版本开始，该操作运行于独立的线程中,并支持更多的并发数。用户可通过设置innodb_purge_threads配置参数来选择清除操作是否使用单</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 独线程,默认情况下参数设置为0(不使用单独线程),设置为 1 时表示使用单独的清除线程。建议为1</span></span>
<span class="line"><span style="color:#C678DD;">innodb_flush_log_at_trx_commit</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 2</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 0：如果innodb_flush_log_at_trx_commit的值为0,log buffer每秒就会被刷写日志文件到磁盘，提交事务的时候不做任何操作（执行是由mysql的master thread线程来执行的。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 主线程中每秒会将重做日志缓冲写入磁盘的重做日志文件(REDO LOG)中。不论事务是否已经提交）默认的日志文件是ib_logfile0,ib_logfile1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 1：当设为默认值1的时候，每次提交事务的时候，都会将log buffer刷写到日志。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 2：如果设为2,每次提交事务都会写日志，但并不会执行刷的操作。每秒定时会刷到日志文件。要注意的是，并不能保证100%每秒一定都会刷到磁盘，这要取决于进程的调度。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 每次事务提交的时候将数据写入事务日志，而这里的写入仅是调用了文件系统的写入操作，而文件系统是有 缓存的，所以这个写入并不能保证数据已经写入到物理磁盘</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 默认值1是为了保证完整的ACID。当然，你可以将这个配置项设为1以外的值来换取更高的性能，但是在系统崩溃的时候，你将会丢失1秒的数据。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 设为0的话，mysqld进程崩溃的时候，就会丢失最后1秒的事务。设为2,只有在操作系统崩溃或者断电的时候才会丢失最后1秒的数据。InnoDB在做恢复的时候会忽略这个值。</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 总结</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 设为1当然是最安全的，但性能页是最差的（相对其他两个参数而言，但不是不能接受）。如果对数据一致性和完整性要求不高，完全可以设为2，如果只最求性能，例如高并发写的日志服务器，设为0来获得更高性能</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#C678DD;">innodb_log_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，但意外的故障将会丢失数据。MySQL开发人员建议设置为1－8M之间</span></span>
<span class="line"><span style="color:#C678DD;">innodb_redo_log_capacity</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 32M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 此参数确定数据日志文件的大小，更大的设置可以提高性能，但也会增加恢复故障数据库所需的时间</span></span>
<span class="line"><span style="color:#C678DD;">innodb_max_dirty_pages_pct</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 90</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># innodb主线程刷新缓存池中的数据，使脏数据比例小于90%</span></span>
<span class="line"><span style="color:#C678DD;">innodb_lock_wait_timeout</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 30</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># InnoDB事务在被回滚之前可以等待一个锁定的超时秒数。InnoDB在它自己的锁定表中自动检测事务死锁并且回滚事务。InnoDB用LOCK TABLES语句注意到锁定设置。默认值是50秒</span></span>
<span class="line"><span style="color:#C678DD;">bulk_insert_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 服务器关闭交互式连接前等待活动的秒数。交互式客户端定义为在mysql_real_connect()中使用CLIENT_INTERACTIVE选项的客户端。默认值：28800秒（8小时）</span></span>
<span class="line"><span style="color:#C678DD;">wait_timeout</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 28800</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 服务器关闭非交互连接之前等待活动的秒数。在线程启动时，根据全局wait_timeout值或全局interactive_timeout值初始化会话wait_timeout值，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 取决于客户端类型(由mysql_real_connect()的连接选项CLIENT_INTERACTIVE定义)。参数默认值：28800秒（8小时）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># MySQL服务器所支持的最大连接数是有上限的，因为每个连接的建立都会消耗内存，因此我们希望客户端在连接到MySQL Server处理完相应的操作后，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 应该断开连接并释放占用的内存。如果你的MySQL Server有大量的闲置连接，他们不仅会白白消耗内存，而且如果连接一直在累加而不断开，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 最终肯定会达到MySQL Server的连接上限数，这会报&#39;too many connections&#39;的错误。对于wait_timeout的值设定，应该根据系统的运行情况来判断。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 在系统运行一段时间后，可以通过show processlist命令查看当前系统的连接状态，如果发现有大量的sleep状态的连接进程，则说明该参数设置的过大，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 可以进行适当的调整小些。要同时设置interactive_timeout和wait_timeout才会生效。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">[mysqldump]</span></span>
<span class="line"><span style="color:#98C379;">quick</span></span>
<span class="line"><span style="color:#C678DD;">max_allowed_packet</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 32M </span><span style="color:#7F848E;font-style:italic;">#服务器发送和接受的最大包长度</span></span>
<span class="line"><span style="color:#61AFEF;">[myisamchk]</span></span>
<span class="line"><span style="color:#C678DD;">key_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#C678DD;">sort_buffer_size</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 8M</span></span>
<span class="line"><span style="color:#C678DD;">read_buffer</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4M</span></span>
<span class="line"><span style="color:#C678DD;">write_buffer</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 4M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>添加 mysql 用户和用户组用于启动 mysql groupadd mysql &amp;&amp; useradd -r -g mysql mysql 设置 mysql 为非登录用户 usermod -s sbin/nologin mysql（可选，设置后无法 su mysql）</li><li>执行数据库初始化命令 （尾行会输出数据库的初始化密码）</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">chown</span><span style="color:#D19A66;"> -R</span><span style="color:#98C379;"> mysql.mysql</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31</span></span>
<span class="line"><span style="color:#61AFEF;">su</span><span style="color:#98C379;"> mysql</span></span>
<span class="line"><span style="color:#61AFEF;">./bin/mysqld</span><span style="color:#D19A66;"> --defaults-file=/usr/mpsp/mysql-8.0.31/my.cnf</span><span style="color:#D19A66;"> --initialize</span></span>
<span class="line"><span style="color:#61AFEF;">cat</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/logs/error.log</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>创建 system 服务方便启动和管理 <code>vim /usr/lib/systemd/system/mysql.service</code>（root 用户操作）</li></ol><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">[Unit]</span></span>
<span class="line"><span style="color:#C678DD;">Description</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">MySQL server</span></span>
<span class="line"><span style="color:#C678DD;">After</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">syslog.target network.target</span></span>
<span class="line"><span style="color:#98C379;"> </span></span>
<span class="line"><span style="color:#61AFEF;">[Service]</span></span>
<span class="line"><span style="color:#C678DD;">User</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">mysql</span></span>
<span class="line"><span style="color:#C678DD;">Group</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">mysql</span></span>
<span class="line"><span style="color:#C678DD;">Type</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">forking</span></span>
<span class="line"><span style="color:#C678DD;">TimeoutSec</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#PermissionsStartOnly=true</span></span>
<span class="line"><span style="color:#C678DD;">ExecStart</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">/usr/mpsp/mysql-8.0.31/bin/mysqld --</span><span style="color:#C678DD;">defaults-file</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">/usr/mpsp/mysql-8.0.31/my.cnf --daemonize</span></span>
<span class="line"><span style="color:#C678DD;">LimitNOFILE</span><span style="color:#ABB2BF;"> =</span><span style="color:#98C379;"> 65535</span></span>
<span class="line"><span style="color:#C678DD;">Restart</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">on-failure</span></span>
<span class="line"><span style="color:#C678DD;">RestartSec</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">3</span></span>
<span class="line"><span style="color:#C678DD;">RestartPreventExitStatus</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">1</span></span>
<span class="line"><span style="color:#C678DD;">PrivateTmp</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">[Install]</span></span>
<span class="line"><span style="color:#C678DD;">WantedBy</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">multi-user.target</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="8"><li>重新加载 systemctl 配置后启动 mysql 服务并添加至开机自启 <code>systemctl daemon-reload &amp;&amp; systemctl start mysql &amp;&amp; systemctl enable mysql</code>至此两台服务器上的 mysql 均安装完毕</li><li>开始做 192.168.6.100（master） &lt;- 192.168.6.101（slave）首先登录 192.168.6.100。通过 sock 登录 mysql<code>./bin/mysql -uroot -S /usr/mpsp/mysql-8.0.31/other/mysql.sock -p</code>（密码就是之前保存的）</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">-- 修改默认的 root 密码 </span></span>
<span class="line"><span style="color:#C678DD;">alter</span><span style="color:#C678DD;"> user</span><span style="color:#98C379;"> &#39;root&#39;</span><span style="color:#ABB2BF;">@</span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;"> identified </span><span style="color:#C678DD;">with</span><span style="color:#ABB2BF;"> mysql_native_password </span><span style="color:#C678DD;">by</span><span style="color:#98C379;"> &#39;mysql123&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> mysql;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 允许远程登录</span></span>
<span class="line"><span style="color:#C678DD;">update</span><span style="color:#ABB2BF;"> user </span><span style="color:#C678DD;">set</span><span style="color:#ABB2BF;"> host </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &#39;%&#39;</span><span style="color:#C678DD;">  where</span><span style="color:#ABB2BF;"> user </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 创建用户 mmstate 用作主主复制</span></span>
<span class="line"><span style="color:#C678DD;">create</span><span style="color:#C678DD;"> user</span><span style="color:#ABB2BF;"> &#39;</span><span style="color:#61AFEF;">mmstate</span><span style="color:#ABB2BF;">&#39;@</span><span style="color:#98C379;">&#39;%&#39;</span><span style="color:#ABB2BF;"> identified </span><span style="color:#C678DD;">with</span><span style="color:#ABB2BF;"> mysql_native_password </span><span style="color:#C678DD;">by</span><span style="color:#98C379;"> &#39;mysql123&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 授权所有表，这里可以指定 库名.表名</span></span>
<span class="line"><span style="color:#C678DD;">grant</span><span style="color:#ABB2BF;"> replication slave </span><span style="color:#C678DD;">on</span><span style="color:#ABB2BF;"> *.* </span><span style="color:#C678DD;">to</span><span style="color:#98C379;"> &#39;mmstate&#39;</span><span style="color:#ABB2BF;">@</span><span style="color:#98C379;">&#39;%&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 刷新权限</span></span>
<span class="line"><span style="color:#ABB2BF;">flush privileges;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 记一下结果</span></span>
<span class="line"><span style="color:#ABB2BF;">show </span><span style="color:#C678DD;">master</span><span style="color:#C678DD;"> status</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="10"><li>然后登录 192.168.6.101。通过 sock 登录 mysql <code>./bin/mysql -uroot -S /usr/mpsp/mysql-8.0.31/other/mysql.sock -p</code>（密码就是之前保存的）<!----></li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">-- 修改默认的 root 密码 </span></span>
<span class="line"><span style="color:#C678DD;">alter</span><span style="color:#C678DD;"> user</span><span style="color:#98C379;"> &#39;root&#39;</span><span style="color:#ABB2BF;">@</span><span style="color:#98C379;">&#39;localhost&#39;</span><span style="color:#ABB2BF;"> identified </span><span style="color:#C678DD;">with</span><span style="color:#ABB2BF;"> mysql_native_password </span><span style="color:#C678DD;">by</span><span style="color:#98C379;"> &#39;mysql123&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> mysql;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 允许远程登录</span></span>
<span class="line"><span style="color:#C678DD;">update</span><span style="color:#ABB2BF;"> user </span><span style="color:#C678DD;">set</span><span style="color:#ABB2BF;"> host </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &#39;%&#39;</span><span style="color:#C678DD;">  where</span><span style="color:#ABB2BF;"> user </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;root&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 都写 master（192.168.6.100） 上的配置</span></span>
<span class="line"><span style="color:#ABB2BF;">change </span><span style="color:#C678DD;">master</span><span style="color:#C678DD;"> to</span><span style="color:#ABB2BF;"> master_host</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;192.168.6.100&#39;</span><span style="color:#ABB2BF;">,master_user</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mmstate&#39;</span><span style="color:#ABB2BF;">,master_password</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mysql123&#39;</span><span style="color:#ABB2BF;">,master_log_file</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mysql-bin.000002&#39;</span><span style="color:#ABB2BF;">,master_log_pos</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">1831</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 开启从节点</span></span>
<span class="line"><span style="color:#C678DD;">start</span><span style="color:#ABB2BF;"> slave;</span></span>
<span class="line"><span style="color:#ABB2BF;">flush privileges;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 结果 Slave_IO_Running: Yes  Slave_SQL_Running: Yes 为正常</span></span>
<span class="line"><span style="color:#ABB2BF;">show slave </span><span style="color:#C678DD;">status</span><span style="color:#ABB2BF;"> \G</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="11"><li>主主的话反着再做一边，开始做 192.168.6.100（slave） -&gt; 192.168.6.101（master）首先登录 192.168.6.101。通过 sock 登录 mysql <code>./bin/mysql -uroot -S /usr/mpsp/mysql-8.0.31/other/mysql.sock -p</code></li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">-- 创建用户 mmstate 用作主主复制</span></span>
<span class="line"><span style="color:#C678DD;">create</span><span style="color:#C678DD;"> user</span><span style="color:#ABB2BF;"> &#39;</span><span style="color:#61AFEF;">mmstate</span><span style="color:#ABB2BF;">&#39;@</span><span style="color:#98C379;">&#39;%&#39;</span><span style="color:#ABB2BF;"> identified </span><span style="color:#C678DD;">with</span><span style="color:#ABB2BF;"> mysql_native_password </span><span style="color:#C678DD;">by</span><span style="color:#98C379;"> &#39;mysql123&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 授权所有表，这里可以指定 库名.表名</span></span>
<span class="line"><span style="color:#C678DD;">grant</span><span style="color:#ABB2BF;"> replication slave </span><span style="color:#C678DD;">on</span><span style="color:#ABB2BF;"> *.* </span><span style="color:#C678DD;">to</span><span style="color:#98C379;"> &#39;mmstate&#39;</span><span style="color:#ABB2BF;">@</span><span style="color:#98C379;">&#39;%&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 刷新权限</span></span>
<span class="line"><span style="color:#ABB2BF;">flush privileges;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 记一下结果</span></span>
<span class="line"><span style="color:#ABB2BF;">show </span><span style="color:#C678DD;">master</span><span style="color:#C678DD;"> status</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="12"><li>然后登录 192.168.6.100。通过 sock 登录 mysql <code>./bin/mysql -uroot -S /usr/mpsp/mysql-8.0.31/other/mysql.sock -p</code></li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">-- 都写 master（192.168.6.101）上的配置</span></span>
<span class="line"><span style="color:#ABB2BF;">change </span><span style="color:#C678DD;">master</span><span style="color:#C678DD;"> to</span><span style="color:#ABB2BF;"> master_host</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;192.168.6.101&#39;</span><span style="color:#ABB2BF;">,master_user</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mmstate&#39;</span><span style="color:#ABB2BF;">,master_password</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mysql123&#39;</span><span style="color:#ABB2BF;">,master_log_file</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&#39;mysql-bin.000002&#39;</span><span style="color:#ABB2BF;">,master_log_pos</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">1682</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 开启从节点</span></span>
<span class="line"><span style="color:#C678DD;">start</span><span style="color:#ABB2BF;"> slave;</span></span>
<span class="line"><span style="color:#ABB2BF;">flush privileges;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">-- 结果 Slave_IO_Running: Yes  Slave_SQL_Running: Yes 为正常</span></span>
<span class="line"><span style="color:#ABB2BF;">show slave </span><span style="color:#C678DD;">status</span><span style="color:#ABB2BF;"> \G</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此主主搭建完成</p><h1 id="windows-下-mysql8-二进制安装" tabindex="-1"><a class="header-anchor" href="#windows-下-mysql8-二进制安装"><span>Windows 下 MySQL8 二进制安装</span></a></h1><ol><li><a href="https://downloads.mysql.com/archives/community/" target="_blank" rel="noopener noreferrer">官网</a> 下载二进制包</li><li>解压至安装目录，并在目录下创建 my.ini 文件，写入以下信息（<!---->）</li></ol><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>#设置3306端口</span></span>
<span class="line"><span>port=3306</span></span>
<span class="line"><span>#设置mysql的安装目录</span></span>
<span class="line"><span>basedir=D:\DB\mysql-8.0.27</span></span>
<span class="line"><span>#设置mysql数据库的数据的存放目录</span></span>
<span class="line"><span>datadir=D:\DB\mysql-8.0.27\data</span></span>
<span class="line"><span>#允许最大连接数</span></span>
<span class="line"><span>max_connections=200</span></span>
<span class="line"><span>#允许连接失败的次数。</span></span>
<span class="line"><span>max_connect_errors=10</span></span>
<span class="line"><span>#服务端使用的字符集默认为utf8mb4</span></span>
<span class="line"><span>character-set-server=utf8mb4</span></span>
<span class="line"><span>#创建新表时将使用的默认存储引擎</span></span>
<span class="line"><span>default-storage-engine=INNODB</span></span>
<span class="line"><span>#默认使用&quot;mysql_native_password&quot;插件认证</span></span>
<span class="line"><span>#mysql_native_password</span></span>
<span class="line"><span>default_authentication_plugin=mysql_native_password</span></span>
<span class="line"><span>[mysql]</span></span>
<span class="line"><span>#设置mysql客户端默认字符集</span></span>
<span class="line"><span>default-character-set=utf8mb4</span></span>
<span class="line"><span>[client]</span></span>
<span class="line"><span>#设置mysql客户端连接服务端时默认使用的端口</span></span>
<span class="line"><span>port=3306</span></span>
<span class="line"><span>default-character-set=utf8mb4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>以管理员身份打开 cmd 键入以下命令：mysqld --initialize --console（该命令需要去安装目录下的 bin 目录去执行，或者直接加到系统环境变量里）记录控制台输出的初始密码。如果需要指定配置文件则命令如下：<!---->mysqld --defaults-file=xxx --initialize --console</li></ol><p><img src="/blog/assets/1-BhB3yR_I.png" alt="" width="1581" height="144"></p><ol start="4"><li>安装 mysql 到系统服务：mysqld --install（默认服务名是 MYSQL，如果需要自定义名称则命令为：mysqld --install xxx）如果 MYSQL 的启动配置文件也要修改则命令为 mysqld -install xxx --defaults-file=&quot;xxx\my.ini&quot;（删除系统服务命令：sc delete xxx，手动安装系统服务：sc &lt;server&gt; create [server nam] [binPath=] start=anto server 要以 // 给出 例如：//mysqld.exe 其中 [] 表示参数可选）</li><li>安装完成后键入命令：net start mysql 启动 mysql</li><li>依次键入命令修改 mysql 密码以及开启远程登录权限</li></ol><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#61AFEF;">mysql</span><span style="color:#D19A66;"> -u</span><span style="color:#98C379;"> root</span><span style="color:#D19A66;"> -h</span><span style="color:#98C379;"> localhost</span><span style="color:#D19A66;"> -P</span><span style="color:#D19A66;"> 3306</span><span style="color:#D19A66;"> -p</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 键入之前的控制台密码</span></span>
<span class="line"><span style="color:#61AFEF;">use</span><span style="color:#98C379;"> mysql</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 修改密码</span></span>
<span class="line"><span style="color:#61AFEF;">ALTER</span><span style="color:#98C379;"> USER</span><span style="color:#98C379;"> root@localhost</span><span style="color:#98C379;"> IDENTIFIED</span><span style="color:#98C379;"> BY</span><span style="color:#98C379;"> &#39;自定义密码&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 开启远程登录权限</span></span>
<span class="line"><span style="color:#61AFEF;">update</span><span style="color:#98C379;"> user</span><span style="color:#98C379;"> set</span><span style="color:#98C379;"> host</span><span style="color:#98C379;"> =&#39;%&#39;</span><span style="color:#98C379;"> where</span><span style="color:#98C379;"> user</span><span style="color:#98C379;"> =&#39;root&#39;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 刷新权限</span></span>
<span class="line"><span style="color:#61AFEF;">flush</span><span style="color:#98C379;"> privileges</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">exit</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="mysql-锁排查" tabindex="-1"><a class="header-anchor" href="#mysql-锁排查"><span>MySQL 锁排查</span></a></h1><h2 id="dml-排查" tabindex="-1"><a class="header-anchor" href="#dml-排查"><span>DML 排查</span></a></h2><p>MDL 全称为 metadata lock，即元数据锁。MDL 锁主要作用是维护表元数据的数据一致性，在表上有活动事务（显式或隐式）的时候，不可以对元数据进行写入操作。因此从 MySQL5.5 版本开始引入了 MDL 锁，来保护表的元数据信息，用于解决或者保证 DDL 操作与 DML 操作之间的一致性。</p><ol><li>可以通过查询表<code>performance_schema`.metadata_locks、`performance_schema`.threads、`performance_schema`.`processlist</code>列出锁的信息、用户信息、连接信息</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> ml.*,p.* </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.metadata_locks ml </span><span style="color:#C678DD;">LEFT JOIN</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.threads t </span><span style="color:#C678DD;">ON</span><span style="color:#D19A66;"> ml</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">OWNER_THREAD_ID</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> t</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">THREAD_ID</span><span style="color:#C678DD;"> LEFT JOIN</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.</span><span style="color:#98C379;">`processlist`</span><span style="color:#ABB2BF;"> p </span><span style="color:#C678DD;">ON</span><span style="color:#D19A66;"> t</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">PROCESSLIST_ID</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> p</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">ID</span><span style="color:#C678DD;"> WHERE</span><span style="color:#D19A66;"> ml</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">OWNER_THREAD_ID</span><span style="color:#56B6C2;"> !=</span><span style="color:#D19A66;"> sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">ps_thread_id</span><span style="color:#ABB2BF;">(CONNECTION_ID())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>如果要查看阻塞的线程具体在执行什么 SQL 可以通过以下 SQL 进行查询（这里需要第 1 步中查询出来的线程 ID）</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.events_statements_current </span><span style="color:#C678DD;">WHERE</span><span style="color:#ABB2BF;"> THREAD_ID </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> 上一步查询出来的线程 ID</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="表级锁排查" tabindex="-1"><a class="header-anchor" href="#表级锁排查"><span>表级锁排查</span></a></h2><p>可以通过查询``performance_schema<code>.table_handles</code>来进行排查，主要关注<code>EXTERNAL_LOCK</code>字段</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.table_handles </span><span style="color:#C678DD;">WHERE</span><span style="color:#ABB2BF;"> OBJECT_SCHEMA </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> 数据库名 </span><span style="color:#C678DD;">AND</span><span style="color:#ABB2BF;"> OBJECT_NAME </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> 表名</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="行级锁排查" tabindex="-1"><a class="header-anchor" href="#行级锁排查"><span>行级锁排查</span></a></h2><p>从 MySQL 8.0 开始，在 performance_schema 中提供了一个 data_locks 表用于记录任意事务的锁信息（同时废弃了 information_schema.innodb_locks 表），不需要有锁等待关系存在（注意，该表中只记录 InnoDB 存储引擎层的锁）</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.data_locks</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="查看最近的-top-sql" tabindex="-1"><a class="header-anchor" href="#查看最近的-top-sql"><span>查看最近的 TOP SQL</span></a></h1><ol><li>查询最近的 n 条 sql 按照执行时间排序</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">select</span><span style="color:#ABB2BF;"> THREAD_ID, EVENT_NAME, SOURCE, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(TIMER_WAIT), </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(LOCK_TIME), SQL_TEXT, CURRENT_SCHEMA, MESSAGE_TEXT, ROWS_AFFECTED, ROWS_SENT, ROWS_EXAMINED </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.events_statements_history </span><span style="color:#C678DD;">where</span><span style="color:#ABB2BF;"> CURRENT_SCHEMA </span><span style="color:#56B6C2;">!=</span><span style="color:#98C379;"> &#39;performance_schema&#39;</span><span style="color:#C678DD;"> order by</span><span style="color:#ABB2BF;"> TIMER_WAIT </span><span style="color:#C678DD;">desc</span><span style="color:#C678DD;"> limit</span><span style="color:#D19A66;"> 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>按照查询次数统计排序</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">select</span><span style="color:#ABB2BF;"> SCHEMA_NAME, DIGEST_TEXT, COUNT_STAR, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(SUM_TIMER_WAIT)</span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> sum_time, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(MIN_TIMER_WAIT) </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> min_time, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(AVG_TIMER_WAIT)</span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> avg_time, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(MAX_TIMER_WAIT) </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;">  max_time, </span><span style="color:#D19A66;">sys</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">format_time</span><span style="color:#ABB2BF;">(SUM_LOCK_TIME) </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> sum_lock_time, SUM_ROWS_AFFECTED, SUM_ROWS_SENT, SUM_ROWS_EXAMINED </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.events_statements_summary_by_digest </span><span style="color:#C678DD;">where</span><span style="color:#ABB2BF;"> SCHEMA_NAME </span><span style="color:#C678DD;">is not null</span><span style="color:#C678DD;"> and</span><span style="color:#ABB2BF;"> SCHEMA_NAME </span><span style="color:#56B6C2;">!=</span><span style="color:#98C379;"> &#39;performance_schema&#39;</span><span style="color:#C678DD;"> order by</span><span style="color:#ABB2BF;"> COUNT_STAR </span><span style="color:#C678DD;">desc</span><span style="color:#C678DD;"> limit</span><span style="color:#D19A66;"> 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>MySQL 的 events_statements_history 表或者 events_statements_history_long 表会记录所有客户端执行过的 SQL，即使执行错误也会记录。可以通过查询这两张表做一些 sql 语法错误统计。执行 SQL 出错时，字段 MYSQL_ERRNO 不为 0</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.events_statements_history </span><span style="color:#C678DD;">where</span><span style="color:#ABB2BF;"> MYSQL_ERRNO </span><span style="color:#56B6C2;">!=</span><span style="color:#D19A66;"> 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="查看-sql-执行进度" tabindex="-1"><a class="header-anchor" href="#查看-sql-执行进度"><span>查看 SQL 执行进度</span></a></h1><p>可通过以下 SQL 实现，需要提供执行 SQL 的连接 id，否则就按照 current_statement 字段展示的正在执行的 SQL 判断。process 字段表示执行进度</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `sys`</span><span style="color:#ABB2BF;">.</span><span style="color:#98C379;">`session`</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="主从复制问题排查" tabindex="-1"><a class="header-anchor" href="#主从复制问题排查"><span>主从复制问题排查</span></a></h1><p>MySQL 从库复出错时一般通过<code>show slave status \G</code>查看报错信息，但是该信息不是很全面，详细信息可以通过查询``performance_schema<code>.replication_applier_status_by_worker</code>表（要在从库进行查询）</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> * </span><span style="color:#C678DD;">FROM</span><span style="color:#98C379;"> `performance_schema`</span><span style="color:#ABB2BF;">.replication_applier_status_by_worker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果要查看复制进度可以查询``mysql<code>.slave_master_info、</code>mysql<code>.slave_relay_log_info</code>表（要在从库进行查询）前者提供查询 I/O 线程读取主库的位置信息，以及从库连接主库的 IP 地址、账号、端口、密码等信息后者提供查询 SQL 线程重放的 binlog 文件对应的主库位置和中继日志当前最新的位置信息</p><h1 id="mysql-查看数据库占用磁盘大小" tabindex="-1"><a class="header-anchor" href="#mysql-查看数据库占用磁盘大小"><span>MySQL 查看数据库占用磁盘大小</span></a></h1><p>table_schema 就是数据库名，占用空间包含实际数据 + 索引</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#C678DD;">SELECT</span><span style="color:#ABB2BF;"> table_schema </span><span style="color:#C678DD;">as</span><span style="color:#98C379;"> &#39;数据库名称&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#56B6C2;">SUM</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">round</span><span style="color:#ABB2BF;">(((data_length + index_length) / </span><span style="color:#D19A66;">1024</span><span style="color:#ABB2BF;"> / </span><span style="color:#D19A66;">1024</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">)) </span><span style="color:#C678DD;">as</span><span style="color:#98C379;"> &#39;数据库大小(MB)&#39;</span></span>
<span class="line"><span style="color:#C678DD;">FROM</span><span style="color:#D19A66;"> information_schema</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">TABLES</span></span>
<span class="line"><span style="color:#C678DD;">WHERE</span><span style="color:#ABB2BF;"> table_schema </span><span style="color:#C678DD;">in</span><span style="color:#ABB2BF;"> (</span><span style="color:#98C379;">&#39;autotwo&#39;</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&#39;zbxdata&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">GROUP BY</span><span style="color:#ABB2BF;"> table_schema;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="mysql-数据备份及恢复" tabindex="-1"><a class="header-anchor" href="#mysql-数据备份及恢复"><span>MySQL 数据备份及恢复</span></a></h1><p>少量数据一般使用 mysqldump 就可将数据导出，但是这个工具有两点需要注意：</p><ol><li>mysqldump 导出数据时会锁表，因此需要添加<code>--single-transaction</code>参数避免</li><li>该工具的导出速度过慢，如果有几十个 G 的数据需要导出则需要换导出工具</li></ol><p>Xtrabackup 是由 Percona 公司开源的一款 MySQL 物理热备份工具，目前社区非常活跃，是 MySQL 开源社区的主流备份工具，可在<a href="https://www.percona.com/downloads" target="_blank" rel="noopener noreferrer">官网</a>直接下载。选择对 MySQL 备份的版本即可。注意这里的版本一定要和使用的 MySQL 版本一致</p><p><img src="/blog/assets/2-DXO1ljqh.png" alt="" width="3517" height="897"></p><p>下载完成后直接解压即可使用，以下是备份整库的命令（<!---->）：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># parallel 指开几个线程备份，target-dir 则是导出后存放的目录</span></span>
<span class="line"><span style="color:#61AFEF;">./xtrabackup</span><span style="color:#D19A66;"> --backup</span><span style="color:#D19A66;"> -u</span><span style="color:#98C379;"> root</span><span style="color:#D19A66;"> -S</span><span style="color:#98C379;"> /usr/mpsp/mysql-8.0.31/other/mysql.sock</span><span style="color:#D19A66;"> -p</span><span style="color:#98C379;">&#39;mysql123&#39;</span><span style="color:#D19A66;"> --parallel=5</span><span style="color:#D19A66;"> --target-dir=/usr/log/backup/</span><span style="color:#98C379;">`</span><span style="color:#61AFEF;">date</span><span style="color:#98C379;"> +&quot;%F_%H_%M_%S&quot;`</span><span style="color:#61AFEF;"> 2</span><span style="color:#ABB2BF;">&gt;</span><span style="color:#98C379;">/usr/log/backup/xtrabackup.log</span><span style="color:#ABB2BF;"> &amp;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 导出后通过 tar 命令进行打包压缩</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>备份完成后会在导出目录下额外生成一些文件用于记录备份信息，其中<code>xtrabackup_binlog_info</code>文件记录了本次备份时的 binlog 文件和 pos 信息，该信息可用于从库进行同步的起点。该工具相当于是把 MySQL 的 data 目录完整的复制了出来，并且处理了 redo 和 undo 日志，因此恢复时则是预处理完导出目录后将其替换要恢复数据的 data 目录即可。</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># 首先预处理备份的目录，use-memory 可限制使恢复时使用的内存，默认是 100M</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># target-dir 指的是待恢复的目录不是恢复到的目录</span></span>
<span class="line"><span style="color:#61AFEF;">./xtrabackup</span><span style="color:#D19A66;"> --prepare</span><span style="color:#D19A66;"> --use-memory=2G</span><span style="color:#D19A66;"> --target-dir=./</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 修改目录下文件的归属，需要和 MySQL 保持一致</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 然后将恢复完成的目录替换数据库的 data 目录即可，最后重启 MySQL</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果需要继续做同步，则根据 <code>xtrabackup_binlog_info</code>文件指定 binglog 和 pos<code>change master to master_host=&#39;172.21.80.65&#39;,master_user=&#39;mmstate&#39;,master_password=&#39;mysql123&#39;,master_log_file=&#39;mysql-bin.000093&#39;,master_log_pos=157;</code></p><h1 id="mysql-主从同步添加监控" tabindex="-1"><a class="header-anchor" href="#mysql-主从同步添加监控"><span>MySQL 主从同步添加监控</span></a></h1><p>可以通过执行<code>show slave status \G</code>查看同步状态，以下是监控脚本，可以添加到 crontab 定时执行</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#7F848E;font-style:italic;">#!/bin/sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">CMD</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">/usr/mpsp/mysql-8.0.31/bin/mysql</span></span>
<span class="line"><span style="color:#E06C75;">MYSQL_USER</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">root</span></span>
<span class="line"><span style="color:#E06C75;">MYSQL_PASSWORD</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">mysql123</span></span>
<span class="line"><span style="color:#E06C75;">MYSQL_SOCK</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">/usr/mpsp/mysql-8.0.31/other/mysql.sock</span></span>
<span class="line"><span style="color:#E06C75;">RESET_FLAG_FILE</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">/usr/mpsp/mysql-8.0.31/flag_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">COUNTER</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">$(</span><span style="color:#E06C75;">$CMD</span><span style="color:#ABB2BF;"> -u</span><span style="color:#E06C75;">$MYSQL_USER</span><span style="color:#ABB2BF;"> -p</span><span style="color:#E06C75;">$MYSQL_PASSWORD</span><span style="color:#ABB2BF;"> -S </span><span style="color:#E06C75;">$MYSQL_SOCK</span><span style="color:#ABB2BF;"> -e </span><span style="color:#98C379;">&quot;show slave status\G&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#61AFEF;">grep</span><span style="color:#D19A66;"> -E</span><span style="color:#98C379;"> &quot;Slave_IO_Running|Slave_SQL_Running&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#61AFEF;">grep</span><span style="color:#D19A66;"> -o</span><span style="color:#98C379;"> &quot;Yes&quot;</span><span style="color:#ABB2BF;"> | </span><span style="color:#61AFEF;">wc</span><span style="color:#D19A66;"> -l</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">RESET_FLAG</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">$(</span><span style="color:#61AFEF;">cat</span><span style="color:#E06C75;"> $RESET_FLAG_FILE</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> [ </span><span style="color:#56B6C2;">-z</span><span style="color:#98C379;"> &quot;</span><span style="color:#E06C75;">$RESET_FLAG</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;"> ] &amp;&amp; [ </span><span style="color:#98C379;">&quot;</span><span style="color:#E06C75;">$COUNTER</span><span style="color:#98C379;">&quot;</span><span style="color:#56B6C2;"> -ne</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;"> ]; </span><span style="color:#C678DD;">then</span></span>
<span class="line"><span style="color:#E06C75;">    task_name</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&quot;MySQL 从节点同步任务失败，IP 172.22.80.65&quot;</span></span>
<span class="line"><span style="color:#E06C75;">    url</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&quot;http://172.26.30.201:8080/smsParserService/downsms&quot;</span></span>
<span class="line"><span style="color:#E06C75;">    phones</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;xxxxxxxxxxx&quot;</span><span style="color:#98C379;"> &quot;xxxxxxxxxxx&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> phone</span><span style="color:#C678DD;"> in</span><span style="color:#98C379;"> &quot;${</span><span style="color:#E06C75;">phones</span><span style="color:#98C379;">[</span><span style="color:#ABB2BF;">@</span><span style="color:#98C379;">]}&quot;</span></span>
<span class="line"><span style="color:#C678DD;">    do</span></span>
<span class="line"><span style="color:#E06C75;">        cur_time</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">$(</span><span style="color:#61AFEF;">date</span><span style="color:#98C379;"> +%s%3N</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#61AFEF;">        curl</span><span style="color:#D19A66;"> -X</span><span style="color:#98C379;"> POST</span><span style="color:#D19A66;"> -H</span><span style="color:#98C379;"> &quot;Content-Type: text/xml;charset=UTF-8&quot;</span><span style="color:#D19A66;"> -d</span><span style="color:#98C379;"> &quot;&lt;map&gt; &lt;entry&gt; &lt;string&gt;calling&lt;/string&gt; &lt;string&gt;</span><span style="color:#E06C75;">$phone</span><span style="color:#98C379;">&lt;/string&gt; &lt;/entry&gt; &lt;entry&gt; &lt;string&gt;rpid&lt;/string&gt; &lt;string&gt;MySQL</span><span style="color:#E06C75;">$cur_time</span><span style="color:#98C379;">&lt;/string&gt; &lt;/entry&gt; &lt;entry&gt; &lt;string&gt;funCode&lt;/string&gt; &lt;string&gt;PUSHSMS&lt;/string&gt; &lt;/entry&gt; &lt;entry&gt; &lt;string&gt;intrType&lt;/string&gt; &lt;string&gt;COMMON_SMS_CONTENT&lt;/string&gt; &lt;/entry&gt; &lt;entry&gt; &lt;string&gt;smsContent&lt;/string&gt; &lt;string&gt;</span><span style="color:#E06C75;">$task_name</span><span style="color:#98C379;">&lt;/string&gt; &lt;/entry&gt; &lt;/map&gt;&quot;</span><span style="color:#E06C75;"> $url</span></span>
<span class="line"><span style="color:#C678DD;">    done</span></span>
<span class="line"><span style="color:#56B6C2;">    echo</span><span style="color:#98C379;"> &quot;$(</span><span style="color:#61AFEF;">date</span><span style="color:#98C379;"> +&#39;%Y-%m-%d&#39;)&quot;</span><span style="color:#ABB2BF;"> &gt; </span><span style="color:#E06C75;">$RESET_FLAG_FILE</span></span>
<span class="line"><span style="color:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> [ </span><span style="color:#98C379;">&quot;$(</span><span style="color:#61AFEF;">cat</span><span style="color:#E06C75;"> $RESET_FLAG_FILE</span><span style="color:#98C379;">)&quot;</span><span style="color:#56B6C2;"> !=</span><span style="color:#98C379;"> &quot;$(</span><span style="color:#61AFEF;">date</span><span style="color:#98C379;"> +&#39;%Y-%m-%d&#39;)&quot;</span><span style="color:#ABB2BF;"> ]; </span><span style="color:#C678DD;">then</span></span>
<span class="line"><span style="color:#ABB2BF;">    &gt; </span><span style="color:#E06C75;">$RESET_FLAG_FILE</span></span>
<span class="line"><span style="color:#C678DD;">fi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!----><div class="vp-doc-copyright" data-v-e0bef33b><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-309da98c><a href="#doc-copyright" class="header-anchor" data-v-309da98c><span data-v-309da98c><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-2a9548e5><p data-v-2a9548e5><span data-v-2a9548e5>版权归属：</span><a class="vp-link no-icon link" href="https://github.com/upcloudrabbit" target="_blank" rel="noreferrer" data-v-2a9548e5 data-v-442a52aa><!--[-->upcloudrabbit<!--]--><!----></a></p><p data-v-2a9548e5><span data-v-2a9548e5>本文链接：</span><a class="vp-link no-icon link" href="/blog/article/lzprr0pb/" data-allow-mismatch data-v-2a9548e5 data-v-442a52aa><!--[-->/article/lzprr0pb/<!--]--><!----></a></p><p data-v-2a9548e5><span data-v-2a9548e5>许可证：</span><a class="vp-link no-icon link" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer" data-v-2a9548e5 data-v-442a52aa><!--[-->署名 4.0 国际 (CC-BY-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-2a9548e5></span><span class="vpi-license-by" data-v-2a9548e5></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-e0bef33b data-v-f7268517><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-f7268517><span class="contributors-label" data-v-f7268517>贡献者: </span><span class="contributors-info" data-v-f7268517><!--[--><!--[--><span class="contributor" data-v-f7268517>upcloudrabbit</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-f7268517><div class="pager" data-v-f7268517><a class="vp-link no-icon link pager-link prev" href="/blog/article/tm7k59or/" data-v-f7268517 data-v-442a52aa><!--[--><span class="desc" data-v-f7268517>上一页</span><span class="title" data-v-f7268517>mongodb</span><!--]--><!----></a></div><div class="pager" data-v-f7268517><a class="vp-link no-icon link pager-link next" href="/blog/article/t04w874u/" data-v-f7268517 data-v-442a52aa><!--[--><span class="desc" data-v-f7268517>下一页</span><span class="title" data-v-f7268517>hotspot源码编译</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-68cd6b44 data-v-f098172b><span class="percent" data-allow-mismatch data-v-f098172b>0%</span><span class="show icon vpi-back-to-top" data-v-f098172b></span><svg aria-hidden="true" data-v-f098172b><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-f098172b></circle></svg></button><footer class="vp-footer" vp-footer data-v-68cd6b44 data-v-400675cf><!--[--><div class="container" data-v-400675cf><p class="message" data-v-400675cf>Power by upcloudrabbit</p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/blog/assets/app-CJfFg5nr.js" defer></script></body></html>